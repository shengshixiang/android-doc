# README

电池的一些状态含义

# BatteryManager.EXTRA_STATUS

    > public static final String EXTRA_STATUS = "status";

* batteryS.status = intent.getIntExtra(BatteryManager.EXTRA_STATUS, -1);

* public static final int BATTERY_STATUS_UNKNOWN = Constants.BATTERY_STATUS_UNKNOWN; // 1

* public static final int BATTERY_STATUS_CHARGING = Constants.BATTERY_STATUS_CHARGING;// 2

* public static final int BATTERY_STATUS_DISCHARGING = Constants.BATTERY_STATUS_DISCHARGING;// 3

* public static final int BATTERY_STATUS_NOT_CHARGING = Constants.BATTERY_STATUS_NOT_CHARGING; // 4

* public static final int BATTERY_STATUS_FULL = Constants.BATTERY_STATUS_FULL;// 5

## Constants

* import android.hardware.health.V1_0.Constants;

    > 从源码 UM.9.15/hardware/interfaces/health/1.0/types.hal 自动转化成
    > UM.9.15/out/soong/.intermediates/hardware/interfaces/health/1.0/android.hardware.health-V1.0-java-constants_gen_java/gen/android/ hardware/health/V1_0/Constants.java

```
/**
 * Possible values for Battery Status.
 * Note: These are currently in sync with BatteryManager and must not
 * be extended / altered.
 */
@export(name="", value_prefix="BATTERY_STATUS_")
enum BatteryStatus : int32_t {
    UNKNOWN = 1,
    CHARGING = 2,
    DISCHARGING = 3,
    /** 
     * Battery is *not* charging - special case when charger is present
     * but battery isn't charging
     */  
    NOT_CHARGING = 4,
    FULL = 5,
};
```

```
UM.9.15/out/soong/.intermediates/hardware/interfaces/health/1.0/android.hardware.health-V1.0-java-constants_gen_java/gen/android/ hardware/health/V1_0/Constants.java
// This file is autogenerated by hidl-gen. Do not edit manually.
// Source: android.hardware.health@1.0
// Location: hardware/interfaces/health/1.0/

package android.hardware.health.V1_0;

public class Constants {
    // Values declared in BatteryStatus follow.
    public static final int BATTERY_STATUS_UNKNOWN = 1;
    public static final int BATTERY_STATUS_CHARGING = 2;
    public static final int BATTERY_STATUS_DISCHARGING = 3;
    public static final int BATTERY_STATUS_NOT_CHARGING = 4;
    public static final int BATTERY_STATUS_FULL = 5;

    // Values declared in BatteryHealth follow.
    public static final int BATTERY_HEALTH_UNKNOWN = 1;
    public static final int BATTERY_HEALTH_GOOD = 2;
    public static final int BATTERY_HEALTH_OVERHEAT = 3;
    public static final int BATTERY_HEALTH_DEAD = 4;
    public static final int BATTERY_HEALTH_OVER_VOLTAGE = 5;
    public static final int BATTERY_HEALTH_UNSPECIFIED_FAILURE = 6;
    public static final int BATTERY_HEALTH_COLD = 7;

}
```

# EXTRA_PLUGGED

    > public static final String EXTRA_PLUGGED = "plugged";


* public static final int BATTERY_PLUGGED_AC = OsProtoEnums.BATTERY_PLUGGED_AC; // = 1

* public static final int BATTERY_PLUGGED_USB = OsProtoEnums.BATTERY_PLUGGED_USB; // = 2

* public static final int BATTERY_PLUGGED_WIRELESS = OsProtoEnums.BATTERY_PLUGGED_WIRELESS; // = 4


* public static final int BATTERY_PLUGGED_ANY = BATTERY_PLUGGED_AC | BATTERY_PLUGGED_USB | BATTERY_PLUGGED_WIRELESS;

# EXTRA_LEVEL

    > public static final String EXTRA_LEVEL = "level";

* 电池电量,0-EXTRA_SCALE = 100

    > private static final int BATTERY_SCALE = 100;    // battery capacity is a percentage

# EXTRA_VOLTAGE

    > public static final String EXTRA_VOLTAGE = "voltage";

* 电池电压

# EXTRA_PRESENT

    > public static final String EXTRA_PRESENT = "present";

* 电池是否在位

# EXTRA_HEALTH

    > public static final String EXTRA_HEALTH = "health";

    > UM.9.15/out/soong/.intermediates/hardware/interfaces/health/1.0/android.hardware.health-V1.0-java-constants_gen_java/gen/android/ hardware/health/V1_0/Constants.java

* public static final int BATTERY_HEALTH_UNKNOWN = Constants.BATTERY_HEALTH_UNKNOWN;  // 1 

* public static final int BATTERY_HEALTH_GOOD = Constants.BATTERY_HEALTH_GOOD;  // 2

* public static final int BATTERY_HEALTH_OVERHEAT = Constants.BATTERY_HEALTH_OVERHEAT;// 3

* public static final int BATTERY_HEALTH_DEAD = Constants.BATTERY_HEALTH_DEAD; // 4

* public static final int BATTERY_HEALTH_OVER_VOLTAGE = Constants.BATTERY_HEALTH_OVER_VOLTAGE;// 5

* public static final int BATTERY_HEALTH_UNSPECIFIED_FAILURE = Constants.BATTERY_HEALTH_UNSPECIFIED_FAILURE;// 6

* public static final int BATTERY_HEALTH_COLD = Constants.BATTERY_HEALTH_COLD;// 7

# EXTRA_BATTERY_LOW

    > public static final String EXTRA_BATTERY_LOW = "battery_low";

# EXTRA_SCALE

    > public static final String EXTRA_SCALE = "scale";

* 电池电量的范围,一般是100

* BatteryService.java

    **直接调用BATTERY_SCALE,没用底层的值**

    ```
    private static final int BATTERY_SCALE = 100;    // battery capacity is a percentage
    private void sendBatteryChangedIntentLocked() {
        //  Pack up the values and broadcast them to everyone
        final Intent intent = new Intent(Intent.ACTION_BATTERY_CHANGED);
        intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY
                | Intent.FLAG_RECEIVER_REPLACE_PENDING);

        int icon = getIconLocked(mHealthInfo.batteryLevel);

        intent.putExtra(BatteryManager.EXTRA_SEQUENCE, mSequence);
        intent.putExtra(BatteryManager.EXTRA_STATUS, mHealthInfo.batteryStatus);
        intent.putExtra(BatteryManager.EXTRA_HEALTH, mHealthInfo.batteryHealth);
        intent.putExtra(BatteryManager.EXTRA_PRESENT, mHealthInfo.batteryPresent);
        intent.putExtra(BatteryManager.EXTRA_LEVEL, mHealthInfo.batteryLevel);
        intent.putExtra(BatteryManager.EXTRA_BATTERY_LOW, mSentLowBatteryBroadcast);
        intent.putExtra(BatteryManager.EXTRA_SCALE, BATTERY_SCALE);
        intent.putExtra(BatteryManager.EXTRA_ICON_SMALL, icon);
        intent.putExtra(BatteryManager.EXTRA_PLUGGED, mPlugType);
        intent.putExtra(BatteryManager.EXTRA_VOLTAGE, mHealthInfo.batteryVoltage);
        intent.putExtra(BatteryManager.EXTRA_TEMPERATURE, mHealthInfo.batteryTemperature);
        intent.putExtra(BatteryManager.EXTRA_TECHNOLOGY, mHealthInfo.batteryTechnology);
        intent.putExtra(BatteryManager.EXTRA_INVALID_CHARGER, mInvalidCharger);
        intent.putExtra(BatteryManager.EXTRA_MAX_CHARGING_CURRENT, mHealthInfo.maxChargingCurrent);
        intent.putExtra(BatteryManager.EXTRA_MAX_CHARGING_VOLTAGE, mHealthInfo.maxChargingVoltage);
        intent.putExtra(BatteryManager.EXTRA_CHARGE_COUNTER, mHealthInfo.batteryChargeCounter);
        if (DEBUG) {
            Slog.d(TAG, "Sending ACTION_BATTERY_CHANGED. scale:" + BATTERY_SCALE
                    + ", info:" + mHealthInfo.toString());
        }    

        mHandler.post(() -> ActivityManager.broadcastStickyIntent(intent, UserHandle.USER_ALL));
    }    
    ```

# EXTRA_TEMPERATURE

    > public static final String EXTRA_TEMPERATURE = "temperature";

* 单位为十分之一摄氏度,temperature: 210 = 21度

# EXTRA_TECHNOLOGY

    > public static final String EXTRA_TECHNOLOGY = "technology";

# EXTRA_INVALID_CHARGER

    > public static final String EXTRA_INVALID_CHARGER = "invalid_charger";

# EXTRA_MAX_CHARGING_CURRENT

    > public static final String EXTRA_MAX_CHARGING_CURRENT = "max_charging_current";

# EXTRA_MAX_CHARGING_VOLTAGE

    > public static final String EXTRA_MAX_CHARGING_VOLTAGE = "max_charging_voltage";

# EXTRA_CHARGE_COUNTER

    > public static final String EXTRA_CHARGE_COUNTER = "charge_counter";

# EXTRA_SEQUENCE

    > public static final String EXTRA_SEQUENCE = "seq";

# EXTRA_EVENTS

    > public static final String EXTRA_EVENTS = "android.os.extra.EVENTS";

# EXTRA_EVENT_TIMESTAMP

    > public static final String EXTRA_EVENT_TIMESTAMP = "android.os.extra.EVENT_TIMESTAMP";

# 电池数据更新逻辑简单介绍

* 底层charger 更新电池相关数据

* BatteryService.java mHealthHalCallback 会接收到相关回调

* 中间层怎么回调的先忽略,后面有时间再展开分析

# 底层电池数据

* /sys/class/power_supply/battery

```
A6650:/sys/class/power_supply/battery # ls
capacity                  charge_type                  fcc_stepper_enable     set_ship_mode          type
charge_control_limit      charger_temp                 force_recharge         status                 uevent
charge_control_limit_max  constant_charge_current      health                 step_charging_enabled  voltage_max
charge_counter            constant_charge_current_max  input_current_limited  subsystem              voltage_now
charge_done               current_now                  input_suspend          sw_jeita_enabled       wakeup39
charge_full               cycle_count                  power                  technology
charge_full_design        device                       present                temp
charge_term_current       die_health                   recharge_soc           time_to_full_now
```
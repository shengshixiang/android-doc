<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>victor</title>

      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js?v=4339353d"></script>
        <script src="../../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../../../../_static/translations.js?v=beaddf03"></script>
        <script src="../../../../_static/js/baidutongji.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            victor_文档
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">概要</a></li>
<li><a class="reference internal" href="#id2">配置文件写参数流程</a></li>
<li><a class="reference internal" href="#id3">最终原因</a></li>
<li><a class="reference internal" href="#log">log输出配置</a></li>
<li><a class="reference internal" href="#nfc-nfc">默认关闭nfc,开机nfc流程</a></li>
<li><a class="reference internal" href="#nfc">应用层nfc启动</a></li>
<li><a class="reference internal" href="#user">user版本 ,配置文件的参数还是没写下去</a></li>
<li><a class="reference internal" href="#id4">解决方法</a></li>
<li><a class="reference internal" href="#nci">写入配置文件的nci命令</a><ul>
<li><a class="reference internal" href="#property">获取配置文件设置的property</a></li>
<li><a class="reference internal" href="#stringhex-buffer">string转换成hex buffer</a></li>
<li><a class="reference internal" href="#id5">写入命令</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">Log</a></li>
<li><a class="reference internal" href="#id7">总结</a></li>
<li><a class="reference internal" href="#id8">配置文件 指令解析</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">victor_文档</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs"> 
<li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
<li>概要</li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.forward()">Forward</a></li>
<li style="float: right;margin-left: 10px;"><a href="javascript:history.back()">Go Back</a> | </li>
<li style="float: right;margin-left: 10px;"><a href="/index.html">Home</a> | </li>

      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>概要<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<p>同事说,nfc 配置文件参数不生效</p>
<p>分别下读指令, 2F1402824A</p>
<p>写指令, 20020A01A00D06824A33070007</p>
</section>
<section id="id2">
<h1>配置文件写参数流程<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/hal/phNxpNciHal.cc</p></li>
</ul>
<p>在这支文件的phNxpNciHal_core_initialized,添加log,发现重启log 没有出来.</p>
<p>要在设置里面,打开nfc 开关,log才会出来.看起来phNxpNciHal_core_initialized 函数是动态执行的,不是开机就会执行</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">char</span> <span class="n">RF_ANTENNA_PARAMETER_LIST</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="s2">&quot;ro.fac.cfg.NFC_PARA_1&quot;</span><span class="p">,</span>
	<span class="s2">&quot;ro.fac.cfg.NFC_PARA_2&quot;</span><span class="p">,</span>
	<span class="s2">&quot;ro.fac.cfg.NFC_PARA_3&quot;</span><span class="p">,</span>
	<span class="s2">&quot;ro.fac.cfg.NFC_PARA_4&quot;</span><span class="p">,</span>
	<span class="s2">&quot;ro.fac.cfg.NFC_PARA_5&quot;</span><span class="p">,</span>
	<span class="s2">&quot;ro.fac.cfg.NFC_PARA_6&quot;</span><span class="p">,</span>
	<span class="s2">&quot;ro.fac.cfg.NFC_PARA_7&quot;</span><span class="p">,</span>
	<span class="s2">&quot;ro.fac.cfg.NFC_PARA_8&quot;</span><span class="p">,</span>
	<span class="s2">&quot;ro.fac.cfg.NFC_PARA_9&quot;</span><span class="p">,</span>
	<span class="s2">&quot;ro.fac.cfg.NFC_PARA_10&quot;</span>
<span class="p">};</span>

	<span class="o">/***************</span><span class="n">PAX</span> <span class="n">Antenna</span> <span class="n">Setting</span> <span class="n">start</span><span class="o">*********************/</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>
  <span class="n">numOfRfAntenna</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">RF_ANTENNA_PARAMETER_LIST</span><span class="p">)</span> <span class="o">/</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">RF_ANTENNA_PARAMETER_LIST</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">numOfRfAntenna</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Performing PAX Antenna Setting BLK </span><span class="si">%u</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">antenna_string_buffer</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">antenna_string_buffer</span><span class="p">));</span>
    <span class="n">retlen</span> <span class="o">=</span> <span class="n">property_get</span><span class="p">(</span><span class="n">RF_ANTENNA_PARAMETER_LIST</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">antenna_string_buffer</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">CStringToHexArray</span><span class="p">(</span><span class="n">antenna_string_buffer</span><span class="p">,</span> <span class="n">antenna_hex_buffer</span><span class="p">);</span>
      <span class="n">retlen</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="o">//</span><span class="n">兼容之前用2002开头的配置文件</span>
      <span class="k">if</span><span class="p">((</span><span class="n">antenna_hex_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">antenna_hex_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
                  <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;PAX config file error!&quot;</span><span class="p">);</span>
                  <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">phNxpNciHal_send_ext_cmd</span><span class="p">(</span><span class="n">retlen</span><span class="p">,</span> <span class="n">antenna_hex_buffer</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">nfcFL</span><span class="o">.</span><span class="n">chipType</span> <span class="o">!=</span> <span class="n">pn547C2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">))</span> <span class="p">{</span>
              <span class="n">status</span> <span class="o">=</span> <span class="n">phNxpNciHal_CheckRFCmdRespStatus</span><span class="p">();</span>
              <span class="o">/*</span><span class="n">STATUS</span> <span class="n">INVALID</span> <span class="n">PARAM</span> <span class="mh">0x09</span><span class="o">*/</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0x09</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">phNxpNciHalRFConfigCmdRecSequence</span><span class="p">();</span>
                  <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;PAX Antenna write NFC parameter  </span><span class="si">%s</span><span class="s2"> success!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">RF_ANTENNA_PARAMETER_LIST</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;PAX Antenna Setting BLK </span><span class="si">%u</span><span class="s2"> failed&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id3">
<h1>最终原因<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h1>
<p>同事说是apk的问题,换了一个apk就可以</p>
<p>第一个应用配置文件不生效,A650-NFC-PN7160-Disable-DPC-1.AB.apk</p>
<p>但用第二个应用配置文件可以生效,A650-NFC-PN7160-Complete-Polling-1.0.apk</p>
<p><img alt="0012_0001" src="../../../../_images/0012_0001.jpg" /></p>
</section>
<section id="log">
<h1>log输出配置<a class="headerlink" href="#log" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/log/phNxpLog.h</p></li>
</ul>
<p>可以看到.有两个变量控制log输出,nfc_debug_enabled,gLog_level.hal_log_level</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define NXPLOG_LOG_SILENT_LOGLEVEL 0x00</span>
<span class="c1">#define NXPLOG_LOG_ERROR_LOGLEVEL 0x01</span>
<span class="c1">#define NXPLOG_LOG_WARN_LOGLEVEL 0x02</span>
<span class="c1">#define NXPLOG_LOG_DEBUG_LOGLEVEL 0x03</span>

<span class="c1">#if (ENABLE_HAL_TRACES == TRUE)</span>
<span class="c1">#define NXPLOG_NCIHAL_D(...)                                       \</span>
  <span class="p">{</span>                                                                \
    <span class="k">if</span> <span class="p">((</span><span class="n">nfc_debug_enabled</span><span class="p">)</span> <span class="o">||</span>                                     \
        <span class="p">(</span><span class="n">gLog_level</span><span class="o">.</span><span class="n">hal_log_level</span> <span class="o">&gt;=</span> <span class="n">NXPLOG_LOG_DEBUG_LOGLEVEL</span><span class="p">))</span>   \
      <span class="n">LOG_PRI</span><span class="p">(</span><span class="n">ANDROID_LOG_DEBUG</span><span class="p">,</span> <span class="n">NXPLOG_ITEM_NCIHAL</span><span class="p">,</span> <span class="n">__VA_ARGS__</span><span class="p">);</span> \
  <span class="p">}</span>
<span class="c1">#define NXPLOG_NCIHAL_W(...)                                      \</span>
  <span class="p">{</span>                                                               \
    <span class="k">if</span> <span class="p">((</span><span class="n">nfc_debug_enabled</span><span class="p">)</span> <span class="o">||</span>                                    \
        <span class="p">(</span><span class="n">gLog_level</span><span class="o">.</span><span class="n">hal_log_level</span> <span class="o">&gt;=</span> <span class="n">NXPLOG_LOG_WARN_LOGLEVEL</span><span class="p">))</span>   \
      <span class="n">LOG_PRI</span><span class="p">(</span><span class="n">ANDROID_LOG_WARN</span><span class="p">,</span> <span class="n">NXPLOG_ITEM_NCIHAL</span><span class="p">,</span> <span class="n">__VA_ARGS__</span><span class="p">);</span> \
  <span class="p">}</span>
<span class="c1">#define NXPLOG_NCIHAL_E(...)                                       \</span>
  <span class="p">{</span>                                                                \
    <span class="k">if</span> <span class="p">(</span><span class="n">gLog_level</span><span class="o">.</span><span class="n">hal_log_level</span> <span class="o">&gt;=</span> <span class="n">NXPLOG_LOG_ERROR_LOGLEVEL</span><span class="p">)</span>     \
      <span class="n">LOG_PRI</span><span class="p">(</span><span class="n">ANDROID_LOG_ERROR</span><span class="p">,</span> <span class="n">NXPLOG_ITEM_NCIHAL</span><span class="p">,</span> <span class="n">__VA_ARGS__</span><span class="p">);</span> \
  <span class="p">}</span>
<span class="c1">#else</span>
<span class="c1">#define NXPLOG_NCIHAL_D(...)</span>
<span class="c1">#define NXPLOG_NCIHAL_W(...)</span>
<span class="c1">#define NXPLOG_NCIHAL_E(...)</span>
<span class="c1">#endif /* Logging APIs used by HAL module */</span>
</pre></div>
</div>
<ul class="simple">
<li><p>nfc_debug_enabled</p></li>
</ul>
<p>在phNxpNciHal_MinOpen 的时候,会初始化log,先从<code class="docutils literal notranslate"><span class="pre">UM.9.15/vendor/nxp/nfc/hw/pn7160/libnfc-nci.conf</span></code> 读取NAME_NFC_DEBUG_ENABLED,</p>
<p>一般配置都是1</p>
<p>接着使用nfc.debug_enabled overlay , 不过user跟debug都没配置</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>phNxpNciHal_MinOpen

static void phNxpNciHal_initialize_debug_enabled_flag() {
  unsigned long num = 0;
  char valueStr[PROPERTY_VALUE_MAX] = {0};
  if (GetNxpNumValue(NAME_NFC_DEBUG_ENABLED, &amp;num, sizeof(num))) {
    nfc_debug_enabled = (num == 0) ? false : true;
  }

  int len = property_get(&quot;nfc.debug_enabled&quot;, valueStr, &quot;&quot;);
  if (len &gt; 0) {
    // let Android property override .conf variable
    unsigned debug_enabled = 0;
    sscanf(valueStr, &quot;%u&quot;, &amp;debug_enabled);
    nfc_debug_enabled = (debug_enabled == 0) ? false : true;
  }
  NXPLOG_NCIHAL_D(&quot;nfc_debug_enabled : %d&quot;, nfc_debug_enabled);
}
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>* UM.9.15/vendor/nxp/nfc/hw/pn7160/libnfc-nci.conf

```
NFC_DEBUG_ENABLED=0x01
```
</pre></div>
</div>
<ul>
<li><p>gLog_level.hal_log_level</p>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/log/phNxpLog.cc</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/******************************************************************************</span>
<span class="o">*</span> <span class="n">Function</span>         <span class="n">phNxpLog_InitializeLogLevel</span>
<span class="o">*</span>
<span class="o">*</span> <span class="n">Description</span>      <span class="n">Initialize</span> <span class="ow">and</span> <span class="n">get</span> <span class="n">log</span> <span class="n">level</span> <span class="n">of</span> <span class="n">module</span> <span class="kn">from</span> <span class="nn">libnfc</span><span class="o">-</span><span class="n">nxp</span><span class="o">.</span><span class="n">conf</span>
<span class="o">*</span><span class="ow">or</span>
<span class="o">*</span>                  <span class="n">Android</span> <span class="n">runtime</span> <span class="n">properties</span><span class="o">.</span>
<span class="o">*</span>                  <span class="n">The</span> <span class="n">Android</span> <span class="nb">property</span> <span class="n">nfc</span><span class="o">.</span><span class="n">nxp_global_log_level</span> <span class="ow">is</span> <span class="n">to</span>
<span class="o">*</span>                  <span class="n">define</span> <span class="n">log</span> <span class="n">level</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">modules</span><span class="o">.</span> <span class="n">Modules</span> <span class="n">log</span> <span class="n">level</span> <span class="n">will</span>
<span class="o">*</span><span class="n">overwide</span> <span class="k">global</span> <span class="n">level</span><span class="o">.</span>
<span class="o">*</span>                  <span class="n">The</span> <span class="n">Android</span> <span class="nb">property</span> <span class="n">will</span> <span class="n">overwide</span> <span class="n">the</span> <span class="n">level</span>
<span class="o">*</span>                  <span class="ow">in</span> <span class="n">libnfc</span><span class="o">-</span><span class="n">nxp</span><span class="o">.</span><span class="n">conf</span>
<span class="o">*</span>
<span class="o">*</span>                  <span class="n">Android</span> <span class="nb">property</span> <span class="n">names</span><span class="p">:</span>
<span class="o">*</span>                      <span class="n">nfc</span><span class="o">.</span><span class="n">nxp_log_level_global</span>    <span class="o">*</span> <span class="n">defines</span> <span class="n">log</span> <span class="n">level</span> <span class="k">for</span> <span class="nb">all</span>
<span class="o">*</span><span class="n">modules</span>
<span class="o">*</span>                      <span class="n">nfc</span><span class="o">.</span><span class="n">nxp_log_level_extns</span>     <span class="o">*</span> <span class="n">extensions</span> <span class="n">module</span> <span class="n">log</span>
<span class="o">*</span>                      <span class="n">nfc</span><span class="o">.</span><span class="n">nxp_log_level_hal</span>       <span class="o">*</span> <span class="n">Hal</span> <span class="n">module</span> <span class="n">log</span>
<span class="o">*</span>                      <span class="n">nfc</span><span class="o">.</span><span class="n">nxp_log_level_dnld</span>      <span class="o">*</span> <span class="n">firmware</span> <span class="n">download</span> <span class="n">module</span>
<span class="o">*</span><span class="n">log</span>
<span class="o">*</span>                      <span class="n">nfc</span><span class="o">.</span><span class="n">nxp_log_level_tml</span>       <span class="o">*</span> <span class="n">TML</span> <span class="n">module</span> <span class="n">log</span>
<span class="o">*</span>                      <span class="n">nfc</span><span class="o">.</span><span class="n">nxp_log_level_nci</span>       <span class="o">*</span> <span class="n">NCI</span> <span class="n">transaction</span> <span class="n">log</span>
<span class="o">*</span>
<span class="o">*</span>                  <span class="n">Log</span> <span class="n">Level</span> <span class="n">values</span><span class="p">:</span>
<span class="o">*</span>                      <span class="n">NXPLOG_LOG_SILENT_LOGLEVEL</span>  <span class="mi">0</span>        <span class="o">*</span> <span class="n">No</span> <span class="n">trace</span> <span class="n">to</span> <span class="n">show</span>
<span class="o">*</span>                      <span class="n">NXPLOG_LOG_ERROR_LOGLEVEL</span>   <span class="mi">1</span>        <span class="o">*</span> <span class="n">Show</span> <span class="n">Error</span> <span class="n">trace</span>
<span class="o">*</span><span class="n">only</span>
<span class="o">*</span>                      <span class="n">NXPLOG_LOG_WARN_LOGLEVEL</span>    <span class="mi">2</span>        <span class="o">*</span> <span class="n">Show</span> <span class="ne">Warning</span>
<span class="o">*</span><span class="n">trace</span> <span class="ow">and</span> <span class="n">Error</span> <span class="n">trace</span>
<span class="o">*</span>                      <span class="n">NXPLOG_LOG_DEBUG_LOGLEVEL</span>   <span class="mi">3</span>        <span class="o">*</span> <span class="n">Show</span> <span class="nb">all</span> <span class="n">traces</span>
<span class="o">*</span>
<span class="o">*</span> <span class="n">Returns</span>          <span class="n">void</span>
<span class="o">*</span>
<span class="o">******************************************************************************/</span>
<span class="n">void</span> <span class="n">phNxpLog_InitializeLogLevel</span><span class="p">(</span><span class="n">void</span><span class="p">)</span> <span class="p">{</span>
<span class="n">uint8_t</span> <span class="n">level</span> <span class="o">=</span> <span class="n">phNxpLog_SetGlobalLogLevel</span><span class="p">();</span>
<span class="n">phNxpLog_SetHALLogLevel</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
<span class="n">phNxpLog_SetExtnsLogLevel</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
<span class="n">phNxpLog_SetTmlLogLevel</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
<span class="n">phNxpLog_SetDnldLogLevel</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
<span class="n">phNxpLog_SetNciTxLogLevel</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>

<span class="n">ALOGD_IF</span><span class="p">(</span><span class="n">nfc_debug_enabled</span><span class="p">,</span>
<span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: global =</span><span class="si">%u</span><span class="s2">, Fwdnld =</span><span class="si">%u</span><span class="s2">, extns =</span><span class="si">%u</span><span class="s2">, </span><span class="se">\</span>
<span class="s2">    hal =</span><span class="si">%u</span><span class="s2">, tml =</span><span class="si">%u</span><span class="s2">, ncir =</span><span class="si">%u</span><span class="s2">, </span><span class="se">\</span>
<span class="s2">    ncix =</span><span class="si">%u</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="vm">__func__</span><span class="p">,</span> <span class="n">gLog_level</span><span class="o">.</span><span class="n">global_log_level</span><span class="p">,</span> <span class="n">gLog_level</span><span class="o">.</span><span class="n">dnld_log_level</span><span class="p">,</span>
<span class="n">gLog_level</span><span class="o">.</span><span class="n">extns_log_level</span><span class="p">,</span> <span class="n">gLog_level</span><span class="o">.</span><span class="n">hal_log_level</span><span class="p">,</span>
<span class="n">gLog_level</span><span class="o">.</span><span class="n">tml_log_level</span><span class="p">,</span> <span class="n">gLog_level</span><span class="o">.</span><span class="n">ncir_log_level</span><span class="p">,</span>
<span class="n">gLog_level</span><span class="o">.</span><span class="n">ncix_log_level</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/log/phNxpLog.h</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">struct</span> <span class="n">nci_log_level</span> <span class="p">{</span>
<span class="n">uint8_t</span> <span class="n">global_log_level</span><span class="p">;</span>
<span class="n">uint8_t</span> <span class="n">extns_log_level</span><span class="p">;</span>
<span class="n">uint8_t</span> <span class="n">hal_log_level</span><span class="p">;</span>
<span class="n">uint8_t</span> <span class="n">dnld_log_level</span><span class="p">;</span>
<span class="n">uint8_t</span> <span class="n">tml_log_level</span><span class="p">;</span>
<span class="n">uint8_t</span> <span class="n">ncix_log_level</span><span class="p">;</span>
<span class="n">uint8_t</span> <span class="n">ncir_log_level</span><span class="p">;</span>
<span class="p">}</span> <span class="n">nci_log_level_t</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/vendor/nxp/nfc/hw/pn7160/libnfc-nxp.conf</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NXPLOG_EXTNS_LOGLEVEL</span><span class="o">=</span><span class="mh">0x03</span>
<span class="n">NXPLOG_NCIHAL_LOGLEVEL</span><span class="o">=</span><span class="mh">0x03</span>
<span class="n">NXPLOG_NCIX_LOGLEVEL</span><span class="o">=</span><span class="mh">0x03</span>
<span class="n">NXPLOG_NCIR_LOGLEVEL</span><span class="o">=</span><span class="mh">0x03</span>
<span class="n">NXPLOG_FWDNLD_LOGLEVEL</span><span class="o">=</span><span class="mh">0x03</span>
<span class="n">NXPLOG_TML_LOGLEVEL</span><span class="o">=</span><span class="mh">0x03</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="nfc-nfc">
<h1>默认关闭nfc,开机nfc流程<a class="headerlink" href="#nfc-nfc" title="此标题的永久链接"></a></h1>
<ul>
<li><p>kernel</p>
<p>nfc_i2c_dev_init: Loading NXP NFC I2C driver</p>
</li>
<li><p>hal</p>
<ul>
<li><p>QSSI.12/vendor/paxsz/initrc/init.A6650.common.rc</p>
<blockquote>
<div><p>on property:ro.fac.cfg.NFC=02
start vendor.nfc_hal_service</p>
</div></blockquote>
</li>
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/1.2/android.hardware.nfc&#64;1.2-service.rc</p>
<blockquote>
<div><p>service vendor.nfc_hal_service /vendor/bin/hw/android.hardware.nfc&#64;1.2-service
disabled
user nfc
group nfc</p>
</div></blockquote>
</li>
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/1.2/NxpNfcService.cpp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;vendor/nxp/nxpnfc/1.0/INxpNfc.h&gt;</span>
<span class="nb">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ALOGD</span><span class="p">(</span><span class="s2">&quot;NFC HAL Service 1.2 is starting.&quot;</span><span class="p">);</span>
    <span class="n">sp</span><span class="o">&lt;</span><span class="n">INfc</span><span class="o">&gt;</span> <span class="n">nfc_service</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Nfc</span><span class="p">();</span>

    <span class="n">configureRpcThreadpool</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">true</span> <span class="o">/*</span><span class="n">callerWillJoin</span><span class="o">*/</span><span class="p">);</span>
    <span class="n">status_t</span> <span class="n">status</span> <span class="o">=</span> <span class="n">nfc_service</span><span class="o">-&gt;</span><span class="n">registerAsService</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG_ALWAYS_FATAL</span><span class="p">(</span><span class="s2">&quot;Could not register service for NFC HAL Iface (</span><span class="si">%d</span><span class="s2">).&quot;</span><span class="p">,</span>
                        <span class="n">status</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> 
    <span class="p">}</span>
    <span class="n">sp</span><span class="o">&lt;</span><span class="n">INxpNfc</span><span class="o">&gt;</span> <span class="n">nxp_nfc_service</span> <span class="o">=</span> <span class="n">new</span> <span class="n">NxpNfc</span><span class="p">();</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">nxp_nfc_service</span><span class="o">-&gt;</span><span class="n">registerAsService</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ALOGD</span><span class="p">(</span><span class="s2">&quot;Could not register service for NXP NFC Extn Iface (</span><span class="si">%d</span><span class="s2">).&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">ALOGD</span><span class="p">(</span><span class="s2">&quot;NFC service is ready&quot;</span><span class="p">);</span>
    <span class="n">joinRpcThreadpool</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/extns/impl/NxpNfc.h</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">using</span> <span class="p">::</span><span class="n">vendor</span><span class="p">::</span><span class="n">nxp</span><span class="p">::</span><span class="n">nxpnfc</span><span class="p">::</span><span class="n">V1_0</span><span class="p">::</span><span class="n">INxpNfc</span><span class="p">;</span>

<span class="n">struct</span> <span class="n">NxpNfc</span> <span class="p">:</span> <span class="n">public</span> <span class="n">INxpNfc</span> <span class="p">{</span>
<span class="n">Return</span><span class="o">&lt;</span><span class="n">void</span><span class="o">&gt;</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">uint64_t</span> <span class="n">ioctlType</span><span class="p">,</span> <span class="n">const</span> <span class="n">hidl_vec</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;&amp;</span> <span class="n">inOutData</span><span class="p">,</span>
                    <span class="n">ioctl_cb</span> <span class="n">_hidl_cb</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/intf/nxpnfc/1.0/INxpNfc.hal</p></li>
</ul>
<p>可以看到.定义hal 自动会生成service接口</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">vendor</span><span class="o">.</span><span class="n">nxp</span><span class="o">.</span><span class="n">nxpnfc</span><span class="o">@</span><span class="mf">1.0</span><span class="p">;</span>

<span class="n">interface</span> <span class="n">INxpNfc</span> <span class="p">{</span>
    <span class="o">/*</span>  
    <span class="o">*</span> <span class="n">Performs</span> <span class="n">an</span> <span class="n">General</span> <span class="n">Input</span> <span class="n">Output</span> <span class="n">operations</span><span class="o">.</span>
    <span class="o">*</span>   
    <span class="o">*</span> <span class="n">Based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">ioctlType</span><span class="p">,</span> <span class="nb">input</span> <span class="n">data</span> <span class="nb">bytes</span> <span class="n">are</span> <span class="n">processed</span> <span class="ow">and</span> 
    <span class="o">*</span> <span class="n">Output</span> <span class="n">data</span> <span class="nb">bytes</span> <span class="n">are</span> <span class="n">generated</span><span class="o">.</span>
    <span class="o">*</span> <span class="nd">@param</span> <span class="n">ioctlType</span> <span class="n">contains</span> <span class="nb">type</span> <span class="n">of</span> <span class="n">functionality</span> <span class="k">as</span> <span class="n">below</span>
    <span class="o">*</span>         <span class="n">HAL_NFC_IOCTL_SPI_DWP_SYNC</span> <span class="n">to</span> <span class="n">synchronize</span> <span class="n">access</span> <span class="n">to</span> <span class="n">eSE</span> 
    <span class="o">*</span>         <span class="n">HAL_NFC_INHIBIT_PWR_CNTRL</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">eSE</span> <span class="n">power</span>
    <span class="o">*</span>         <span class="n">HAL_NFC_SET_SPM_PWR</span> <span class="n">to</span> <span class="n">toggle</span> <span class="n">eSE</span> <span class="n">power</span>
    <span class="o">*</span> <span class="nd">@return</span> <span class="n">output</span> <span class="n">data</span> <span class="k">as</span> <span class="n">stream</span> <span class="n">of</span> <span class="nb">bytes</span>
    <span class="o">*/</span>  
    <span class="n">ioctl</span><span class="p">(</span><span class="n">uint64_t</span> <span class="n">ioctlType</span><span class="p">,</span><span class="n">NfcData</span> <span class="n">inputData</span><span class="p">)</span> <span class="n">generates</span><span class="p">(</span><span class="n">NfcData</span> <span class="n">outputData</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/out/soong/.intermediates/hardware/nxp/nfc/intf/nxpnfc/1.0/vendor.nxp.nxpnfc&#64;1.0_genc++_headers/gen/vendor/nxp/nxpnfc/1.0/INxpNfc.h</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>struct INxpNfc : public ::android::hidl::base::V1_0::IBase {
    static ::android::sp&lt;INxpNfc&gt; getService(const std::string &amp;serviceName=&quot;default&quot;, bool getStub=false);
/**
 * Deprecated. See getService(std::string, bool)
 */
static ::android::sp&lt;INxpNfc&gt; getService(const char serviceName[], bool getStub=false)  { std::string str(serviceName ? serviceName : &quot;&quot;);      return getService(str, getStub); }
/**
 * Deprecated. See getService(std::string, bool)
 */
static ::android::sp&lt;INxpNfc&gt; getService(const ::android::hardware::hidl_string&amp; serviceName, bool getStub=false)  { std::string str(serviceName.c_str());      return getService(str, getStub); }
/**
 * Calls getService(&quot;default&quot;, bool). This is the recommended instance name for singleton services.
 */
static ::android::sp&lt;INxpNfc&gt; getService(bool getStub) { return getService(&quot;default&quot;, getStub); }
/**
 * Registers a service with the service manager. For Trebilized devices, the service
 * must also be in the VINTF manifest.
 */
__attribute__ ((warn_unused_result))::android::status_t registerAsService(const std::string &amp;serviceName=&quot;default&quot;);
</pre></div>
</div>
</li>
</ul>
</section>
<section id="nfc">
<h1>应用层nfc启动<a class="headerlink" href="#nfc" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>QSSI.12/packages/apps/Nfc/AndroidManifest.xml</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="o">&lt;</span><span class="n">application</span> <span class="n">android</span><span class="p">:</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;.NfcApplication&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">receiver</span> <span class="n">android</span><span class="p">:</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;.NfcBootCompletedReceiver&quot;</span>
        <span class="n">android</span><span class="p">:</span><span class="n">exported</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">intent</span><span class="o">-</span><span class="nb">filter</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">action</span> <span class="n">android</span><span class="p">:</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;android.intent.action.BOOT_COMPLETED&quot;</span> <span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="n">intent</span><span class="o">-</span><span class="nb">filter</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">receiver</span><span class="o">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>QSSI.12/packages/apps/Nfc/src/com/android/nfc/NfcApplication.java</p></li>
</ul>
<p>因为定义了静态receiver,所以调用NfcApplication</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>public void onCreate() {
        super.onCreate();
        PackageManager pm = getApplicationContext().getPackageManager();
        if (!pm.hasSystemFeature(PackageManager.FEATURE_NFC_ANY)) {
                return;
        }   

        boolean isMainProcess = false;
        // We start a service in a separate process to do
        // handover transfer. We don&#39;t want to instantiate an NfcService
        // object in those cases, hence check the name of the process
        // to determine whether we&#39;re the main NFC service, or the
        // handover process
        ActivityManager am = (ActivityManager)this.getSystemService(ACTIVITY_SERVICE);
        List processes = am.getRunningAppProcesses();
        Iterator i = processes.iterator();
        while (i.hasNext()) {
            RunningAppProcessInfo appInfo = (RunningAppProcessInfo)(i.next());
            if (appInfo.pid == Process.myPid()) {
                isMainProcess =  (NFC_PROCESS.equals(appInfo.processName));
                break;
            }   
        }   
        if (UserHandle.myUserId() == 0 &amp;&amp; isMainProcess) {
            mNfcService = new NfcService(this);
            ThreadedRenderer.enableForegroundTrimming();
        }   
    }   
</pre></div>
</div>
<ul class="simple">
<li><p>QSSI.12/packages/apps/Nfc/nci/src/com/android/nfc/dhimpl/NativeNfcManager.java</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">static</span> <span class="p">{</span>
        <span class="n">System</span><span class="o">.</span><span class="n">loadLibrary</span><span class="p">(</span><span class="s2">&quot;nfc_nci_jni&quot;</span><span class="p">);</span>
    <span class="p">}</span>   
</pre></div>
</div>
<ul>
<li><p>QSSI.12/packages/apps/Nfc/nci/jni/NfcJniUtil.cpp</p>
<p>system.loadLibrary 会调用到libnfc_nci_jni.so的JNI_OnLoad(JavaVM* jvm, void*)</p>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jint</span> <span class="n">JNI_OnLoad</span><span class="p">(</span><span class="n">JavaVM</span><span class="o">*</span> <span class="n">jvm</span><span class="p">,</span> <span class="n">void</span><span class="o">*</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">DLOG_IF</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="n">nfc_debug_enabled</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: enter&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
  <span class="n">JNIEnv</span><span class="o">*</span> <span class="n">e</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>

  <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s2">&quot;NFC Service: loading nci JNI&quot;</span><span class="p">);</span>

  <span class="o">//</span> <span class="n">Check</span> <span class="n">JNI</span> <span class="n">version</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">jvm</span><span class="o">-&gt;</span><span class="n">GetEnv</span><span class="p">((</span><span class="n">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="n">JNI_VERSION_1_6</span><span class="p">))</span> <span class="k">return</span> <span class="n">JNI_ERR</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">android</span><span class="p">::</span><span class="n">register_com_android_nfc_NativeNfcManager</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">JNI_ERR</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">android</span><span class="p">::</span><span class="n">register_com_android_nfc_NativeLlcpServiceSocket</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">JNI_ERR</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">android</span><span class="p">::</span><span class="n">register_com_android_nfc_NativeLlcpSocket</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">JNI_ERR</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">android</span><span class="p">::</span><span class="n">register_com_android_nfc_NativeNfcTag</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">JNI_ERR</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">android</span><span class="p">::</span><span class="n">register_com_android_nfc_NativeLlcpConnectionlessSocket</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">JNI_ERR</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">android</span><span class="p">::</span><span class="n">register_com_android_nfc_NativeP2pDevice</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">JNI_ERR</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">RoutingManager</span><span class="p">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">.</span><span class="n">registerJniFunctions</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">JNI_ERR</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">android</span><span class="p">::</span><span class="n">register_com_android_nfc_NativeT4tNfcee</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">JNI_ERR</span><span class="p">;</span>
  <span class="n">DLOG_IF</span><span class="p">(</span><span class="n">INFO</span><span class="p">,</span> <span class="n">nfc_debug_enabled</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: exit&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">JNI_VERSION_1_6</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li><p>loadConfigEntry</p>
<p>加载nci配置文件,暂时没有找到源码入口</p>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">22</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">50.742</span>  <span class="mi">3390</span>  <span class="mi">3390</span> <span class="n">I</span> <span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">ConfigFile</span> <span class="o">-</span> <span class="n">Parsing</span> <span class="n">file</span> <span class="s1">&#39;/etc/libnfc-nci.conf&#39;</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">22</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">50.742</span>  <span class="mi">3390</span>  <span class="mi">3390</span> <span class="n">I</span> <span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">ConfigFile</span> <span class="o">-</span> <span class="p">[</span><span class="n">APPL_TRACE_LEVEL</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">22</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">50.743</span>  <span class="mi">3390</span>  <span class="mi">3390</span> <span class="n">I</span> <span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">ConfigFile</span> <span class="o">-</span> <span class="p">[</span><span class="n">PROTOCOL_TRACE_LEVEL</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">22</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">50.743</span>  <span class="mi">3390</span>  <span class="mi">3390</span> <span class="n">I</span> <span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">ConfigFile</span> <span class="o">-</span> <span class="p">[</span><span class="n">NFC_DEBUG_ENABLED</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">22</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">50.743</span>  <span class="mi">3390</span>  <span class="mi">3390</span> <span class="n">I</span> <span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">ConfigFile</span> <span class="o">-</span> <span class="p">[</span><span class="n">NFA_STORAGE</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/data/vendor/nfc&quot;</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">22</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">50.743</span>  <span class="mi">3390</span>  <span class="mi">3390</span> <span class="n">I</span> <span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">ConfigFile</span> <span class="o">-</span> <span class="p">[</span><span class="n">HOST_LISTEN_TECH_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x07</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">22</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">50.743</span>  <span class="mi">3390</span>  <span class="mi">3390</span> <span class="n">I</span> <span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">ConfigFile</span> <span class="o">-</span> <span class="p">[</span><span class="n">SCREEN_OFF_POWER_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">22</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">50.743</span>  <span class="mi">3390</span>  <span class="mi">3390</span> <span class="n">I</span> <span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">ConfigFile</span> <span class="o">-</span> <span class="p">[</span><span class="n">NCI_HAL_MODULE</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;nfc_nci.pn54x&quot;</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">22</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">50.743</span>  <span class="mi">3390</span>  <span class="mi">3390</span> <span class="n">I</span> <span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">ConfigFile</span> <span class="o">-</span> <span class="p">[</span><span class="n">POLLING_TECH_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xEF</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">22</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">50.743</span>  <span class="mi">3390</span>  <span class="mi">3390</span> <span class="n">I</span> <span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">ConfigFile</span> <span class="o">-</span> <span class="p">[</span><span class="n">P2P_LISTEN_TECH_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC5</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">22</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">50.743</span>  <span class="mi">3390</span>  <span class="mi">3390</span> <span class="n">I</span> <span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">ConfigFile</span> <span class="o">-</span> <span class="p">[</span><span class="n">PRESERVE_STORAGE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">22</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">50.743</span>  <span class="mi">3390</span>  <span class="mi">3390</span> <span class="n">I</span> <span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">ConfigFile</span> <span class="o">-</span> <span class="p">[</span><span class="n">AID_MATCHING_MODE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">22</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">50.743</span>  <span class="mi">3390</span>  <span class="mi">3390</span> <span class="n">I</span> <span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">ConfigFile</span> <span class="o">-</span> <span class="p">[</span><span class="n">NFA_MAX_EE_SUPPORTED</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">22</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">50.743</span>  <span class="mi">3390</span>  <span class="mi">3390</span> <span class="n">I</span> <span class="n">com</span><span class="o">.</span><span class="n">android</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">ConfigFile</span> <span class="o">-</span> <span class="p">[</span><span class="n">OFFHOST_AID_ROUTE_PWR_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3B</span>
</pre></div>
</div>
<ul>
<li><p>QSSI.12/system/nfc/src/adaptation/NfcAdaptation.cc</p>
<p>后面就到桥梁NfcAdaptation跟hal交互, package/app/Nfc -&gt; system/nfc/NfcAdaptation -&gt; hal</p>
</li>
</ul>
</section>
<section id="user">
<h1>user版本 ,配置文件的参数还是没写下去<a class="headerlink" href="#user" title="此标题的永久链接"></a></h1>
<p>在分析配置文件写流程过程中,发现配置文件还是因为 selinux 权限没有配置下去</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Access</span> <span class="n">denied</span> <span class="n">finding</span> <span class="nb">property</span> <span class="s2">&quot;ro.fac.cfg.NFC_PARA_1&quot;</span>
 <span class="mi">08</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">05.442</span>   <span class="mi">890</span>   <span class="mi">890</span> <span class="n">W</span> <span class="n">nfc</span><span class="o">@</span><span class="mf">1.2</span><span class="o">-</span><span class="n">service</span><span class="p">:</span> <span class="nb">type</span><span class="o">=</span><span class="mi">1400</span> <span class="n">audit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">474</span><span class="p">):</span> <span class="n">avc</span><span class="p">:</span> <span class="n">denied</span> <span class="p">{</span> <span class="n">read</span> <span class="p">}</span> <span class="k">for</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;u:object_r:pax_ctrl_prop:s0&quot;</span> <span class="n">dev</span><span class="o">=</span><span class="s2">&quot;tmpfs&quot;</span> <span class="n">ino</span><span class="o">=</span><span class="mi">11357</span> <span class="n">scontext</span><span class="o">=</span><span class="n">u</span><span class="p">:</span><span class="n">r</span><span class="p">:</span><span class="n">hal_nfc_default</span><span class="p">:</span><span class="n">s0</span> <span class="n">tcontext</span><span class="o">=</span><span class="n">u</span><span class="p">:</span><span class="n">object_r</span><span class="p">:</span><span class="n">pax_ctrl_prop</span><span class="p">:</span><span class="n">s0</span> <span class="n">tclass</span><span class="o">=</span><span class="n">file</span> <span class="n">permissive</span><span class="o">=</span><span class="mi">0</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">05.442</span>   <span class="mi">890</span>   <span class="mi">890</span> <span class="n">W</span> <span class="n">nfc</span><span class="o">@</span><span class="mf">1.2</span><span class="o">-</span><span class="n">service</span><span class="p">:</span> <span class="nb">type</span><span class="o">=</span><span class="mi">1400</span> <span class="n">audit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">475</span><span class="p">):</span> <span class="n">avc</span><span class="p">:</span> <span class="n">denied</span> <span class="p">{</span> <span class="n">read</span> <span class="p">}</span> <span class="k">for</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;u:object_r:pax_ctrl_prop:s0&quot;</span> <span class="n">dev</span><span class="o">=</span><span class="s2">&quot;tmpfs&quot;</span> <span class="n">ino</span><span class="o">=</span><span class="mi">11357</span> <span class="n">scontext</span><span class="o">=</span><span class="n">u</span><span class="p">:</span><span class="n">r</span><span class="p">:</span><span class="n">hal_nfc_default</span><span class="p">:</span><span class="n">s0</span> <span class="n">tcontext</span><span class="o">=</span><span class="n">u</span><span class="p">:</span><span class="n">object_r</span><span class="p">:</span><span class="n">pax_ctrl_prop</span><span class="p">:</span><span class="n">s0</span> <span class="n">tclass</span><span class="o">=</span><span class="n">file</span> <span class="n">permissive</span><span class="o">=</span><span class="mi">0</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">05.442</span>   <span class="mi">890</span>   <span class="mi">890</span> <span class="n">W</span> <span class="n">nfc</span><span class="o">@</span><span class="mf">1.2</span><span class="o">-</span><span class="n">service</span><span class="p">:</span> <span class="nb">type</span><span class="o">=</span><span class="mi">1400</span> <span class="n">audit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">476</span><span class="p">):</span> <span class="n">avc</span><span class="p">:</span> <span class="n">denied</span> <span class="p">{</span> <span class="n">read</span> <span class="p">}</span> <span class="k">for</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;u:object_r:pax_ctrl_prop:s0&quot;</span> <span class="n">dev</span><span class="o">=</span><span class="s2">&quot;tmpfs&quot;</span> <span class="n">ino</span><span class="o">=</span><span class="mi">11357</span> <span class="n">scontext</span><span class="o">=</span><span class="n">u</span><span class="p">:</span><span class="n">r</span><span class="p">:</span><span class="n">hal_nfc_default</span><span class="p">:</span><span class="n">s0</span> <span class="n">tcontext</span><span class="o">=</span><span class="n">u</span><span class="p">:</span><span class="n">object_r</span><span class="p">:</span><span class="n">pax_ctrl_prop</span><span class="p">:</span><span class="n">s0</span> <span class="n">tclass</span><span class="o">=</span><span class="n">file</span> <span class="n">permissive</span><span class="o">=</span><span class="mi">0</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">05.445</span>   <span class="mi">890</span>  <span class="mi">5010</span> <span class="n">D</span> <span class="n">NxpTml</span>  <span class="p">:</span> <span class="n">PN54X</span> <span class="o">-</span> <span class="n">I2C</span> <span class="n">Read</span> <span class="n">successful</span><span class="o">.....</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">05.442</span>   <span class="mi">890</span>   <span class="mi">890</span> <span class="n">W</span> <span class="n">nfc</span><span class="o">@</span><span class="mf">1.2</span><span class="o">-</span><span class="n">service</span><span class="p">:</span> <span class="nb">type</span><span class="o">=</span><span class="mi">1400</span> <span class="n">audit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">477</span><span class="p">):</span> <span class="n">avc</span><span class="p">:</span> <span class="n">denied</span> <span class="p">{</span> <span class="n">read</span> <span class="p">}</span> <span class="k">for</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;u:object_r:pax_ctrl_prop:s0&quot;</span> <span class="n">dev</span><span class="o">=</span><span class="s2">&quot;tmpfs&quot;</span> <span class="n">ino</span><span class="o">=</span><span class="mi">11357</span> <span class="n">scontext</span><span class="o">=</span><span class="n">u</span><span class="p">:</span><span class="n">r</span><span class="p">:</span><span class="n">hal_nfc_default</span><span class="p">:</span><span class="n">s0</span> <span class="n">tcontext</span><span class="o">=</span><span class="n">u</span><span class="p">:</span><span class="n">object_r</span><span class="p">:</span><span class="n">pax_ctrl_prop</span><span class="p">:</span><span class="n">s0</span> <span class="n">tclass</span><span class="o">=</span><span class="n">file</span> <span class="n">permissive</span><span class="o">=</span><span class="mi">0</span>
<span class="mi">08</span><span class="o">-</span><span class="mi">28</span> <span class="mi">14</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">05.442</span>   <span class="mi">890</span>   <span class="mi">890</span> <span class="n">W</span> <span class="n">nfc</span><span class="o">@</span><span class="mf">1.2</span><span class="o">-</span><span class="n">service</span><span class="p">:</span> <span class="nb">type</span><span class="o">=</span><span class="mi">1400</span> <span class="n">audit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">478</span><span class="p">):</span> <span class="n">avc</span><span class="p">:</span> <span class="n">denied</span> <span class="p">{</span> <span class="n">read</span> <span class="p">}</span> <span class="k">for</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;u:object_r:pax_ctrl_prop:s0&quot;</span> <span class="n">dev</span><span class="o">=</span><span class="s2">&quot;tmpfs&quot;</span> <span class="n">ino</span><span class="o">=</span><span class="mi">11357</span> <span class="n">scontext</span><span class="o">=</span><span class="n">u</span><span class="p">:</span><span class="n">r</span><span class="p">:</span><span class="n">hal_nfc_default</span><span class="p">:</span><span class="n">s0</span> <span class="n">tcontext</span><span class="o">=</span><span class="n">u</span><span class="p">:</span><span class="n">object_r</span><span class="p">:</span><span class="n">pax_ctrl_prop</span><span class="p">:</span><span class="n">s0</span> <span class="n">tclass</span><span class="o">=</span><span class="n">file</span> <span class="n">permissive</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
</section>
<section id="id4">
<h1>解决方法<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h1>
<p>添加selinux权限</p>
<ul class="simple">
<li><p>UM.9.15/vendor/nxp/nfc/sepolicy/nfc/hal_nfc_default.te</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">UM</span><span class="mf">.9.15</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">nxp</span><span class="o">/</span><span class="n">nfc</span><span class="o">/</span><span class="n">sepolicy</span><span class="o">/</span><span class="n">nfc</span><span class="o">/</span><span class="n">hal_nfc_default</span><span class="o">.</span><span class="n">te</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">UM</span><span class="mf">.9.15</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">nxp</span><span class="o">/</span><span class="n">nfc</span><span class="o">/</span><span class="n">sepolicy</span><span class="o">/</span><span class="n">nfc</span><span class="o">/</span><span class="n">hal_nfc_default</span><span class="o">.</span><span class="n">te</span>
<span class="o">@@</span> <span class="o">-</span><span class="mi">11</span><span class="p">,</span><span class="mi">3</span> <span class="o">+</span><span class="mi">11</span><span class="p">,</span><span class="mi">4</span> <span class="o">@@</span> <span class="n">allow</span> <span class="n">hal_nfc_default</span> <span class="n">vendor_nfc_prop</span><span class="p">:</span><span class="n">property_service</span> <span class="nb">set</span><span class="p">;</span>
 
 <span class="n">allow</span> <span class="n">hal_nfc_default</span> <span class="n">nfc_vendor_data_file</span><span class="p">:</span><span class="nb">dir</span> <span class="p">{</span> <span class="nb">getattr</span> <span class="n">add_name</span> <span class="n">read</span> <span class="n">write</span> <span class="n">search</span> <span class="n">remove_name</span> <span class="p">};</span>
 <span class="n">allow</span> <span class="n">hal_nfc_default</span> <span class="n">nfc_vendor_data_file</span><span class="p">:</span><span class="n">file</span> <span class="p">{</span> <span class="nb">getattr</span> <span class="nb">open</span> <span class="n">create</span> <span class="n">read</span> <span class="n">write</span> <span class="n">unlink</span> <span class="nb">setattr</span> <span class="n">append</span> <span class="p">};</span>
<span class="o">+</span><span class="n">allow</span> <span class="n">hal_nfc_default</span> <span class="n">pax_ctrl_prop</span><span class="p">:</span><span class="n">file</span> <span class="p">{</span> <span class="nb">getattr</span> <span class="nb">open</span> <span class="n">read</span> <span class="nb">map</span> <span class="p">};</span>
</pre></div>
</div>
</section>
<section id="nci">
<h1>写入配置文件的nci命令<a class="headerlink" href="#nci" title="此标题的永久链接"></a></h1>
<section id="property">
<h2>获取配置文件设置的property<a class="headerlink" href="#property" title="此标题的永久链接"></a></h2>
<p>ro.fac.cfg.NFC_PARA_1-10,init进程解析的</p>
</section>
<section id="stringhex-buffer">
<h2>string转换成hex buffer<a class="headerlink" href="#stringhex-buffer" title="此标题的永久链接"></a></h2>
<p>先算出 与’0’ 或者 ‘a’ ‘A’的插值,然后左移4位,继续算,得到16进制值</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span> <span class="n">CStringToHexArray</span><span class="p">(</span> <span class="n">char</span> <span class="o">*</span><span class="n">pcStr</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">pucArr</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="n">pucHead</span> <span class="o">=</span> <span class="n">pucArr</span><span class="p">;</span>
    <span class="n">unsigned</span> <span class="n">char</span>  <span class="n">ucTmp</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span> <span class="o">!=</span> <span class="o">*</span><span class="n">pcStr</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">&gt;=</span> <span class="s1">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">&lt;=</span> <span class="s1">&#39;9&#39;</span> <span class="p">)</span><span class="n">ucTmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">-</span> <span class="s1">&#39;0&#39;</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">&gt;=</span> <span class="s1">&#39;a&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">&lt;=</span> <span class="s1">&#39;f&#39;</span> <span class="p">)</span><span class="n">ucTmp</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="p">(</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">-</span> <span class="s1">&#39;a&#39;</span> <span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">&gt;=</span> <span class="s1">&#39;A&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">&lt;=</span> <span class="s1">&#39;F&#39;</span> <span class="p">)</span><span class="n">ucTmp</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="p">(</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">-</span> <span class="s1">&#39;A&#39;</span> <span class="p">);</span>
        <span class="k">else</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="n">pcStr</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span> <span class="o">!=</span> <span class="o">*</span><span class="n">pcStr</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ucTmp</span> <span class="o">&lt;&lt;=</span> <span class="mi">4</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">&gt;=</span> <span class="s1">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">&lt;=</span> <span class="s1">&#39;9&#39;</span> <span class="p">)</span><span class="n">ucTmp</span> <span class="o">|=</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">-</span> <span class="s1">&#39;0&#39;</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">&gt;=</span> <span class="s1">&#39;a&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">&lt;=</span> <span class="s1">&#39;f&#39;</span> <span class="p">)</span><span class="n">ucTmp</span> <span class="o">|=</span> <span class="mi">10</span> <span class="o">+</span> <span class="p">(</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">-</span> <span class="s1">&#39;a&#39;</span> <span class="p">);</span>
            <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">&gt;=</span> <span class="s1">&#39;A&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">&lt;=</span> <span class="s1">&#39;F&#39;</span> <span class="p">)</span><span class="n">ucTmp</span> <span class="o">|=</span> <span class="mi">10</span> <span class="o">+</span> <span class="p">(</span> <span class="o">*</span><span class="n">pcStr</span> <span class="o">-</span> <span class="s1">&#39;A&#39;</span> <span class="p">);</span>
            <span class="k">else</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pcStr</span><span class="o">++</span><span class="p">;</span>
        <span class="o">*</span><span class="n">pucArr</span><span class="o">++</span> <span class="o">=</span> <span class="n">ucTmp</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span> <span class="n">pucArr</span> <span class="o">-</span> <span class="n">pucHead</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id5">
<h2>写入命令<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/hal/phNxpNciHal.cc</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">phNxpNciHal_core_initialized</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">core_init_rsp_params_len</span><span class="p">,</span>
                                 <span class="n">uint8_t</span><span class="o">*</span> <span class="n">p_core_init_rsp_params</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">numOfRfAntenna</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">RF_ANTENNA_PARAMETER_LIST</span><span class="p">)</span> <span class="o">/</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">RF_ANTENNA_PARAMETER_LIST</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">numOfRfAntenna</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Performing PAX Antenna Setting BLK </span><span class="si">%u</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">antenna_string_buffer</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">antenna_string_buffer</span><span class="p">));</span>
    <span class="n">retlen</span> <span class="o">=</span> <span class="n">property_get</span><span class="p">(</span><span class="n">RF_ANTENNA_PARAMETER_LIST</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">antenna_string_buffer</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">CStringToHexArray</span><span class="p">(</span><span class="n">antenna_string_buffer</span><span class="p">,</span> <span class="n">antenna_hex_buffer</span><span class="p">);</span>
      <span class="n">retlen</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="o">//</span><span class="n">兼容之前用2002开头的配置文件</span>
      <span class="k">if</span><span class="p">((</span><span class="n">antenna_hex_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">antenna_hex_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
                  <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;PAX config file error!&quot;</span><span class="p">);</span>
                  <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">phNxpNciHal_send_ext_cmd</span><span class="p">(</span><span class="n">retlen</span><span class="p">,</span> <span class="n">antenna_hex_buffer</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">nfcFL</span><span class="o">.</span><span class="n">chipType</span> <span class="o">!=</span> <span class="n">pn547C2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">))</span> <span class="p">{</span>
              <span class="n">status</span> <span class="o">=</span> <span class="n">phNxpNciHal_CheckRFCmdRespStatus</span><span class="p">();</span>
              <span class="o">/*</span><span class="n">STATUS</span> <span class="n">INVALID</span> <span class="n">PARAM</span> <span class="mh">0x09</span><span class="o">*/</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0x09</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">phNxpNciHalRFConfigCmdRecSequence</span><span class="p">();</span>
                  <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;PAX Antenna write NFC parameter  </span><span class="si">%s</span><span class="s2"> success!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">RF_ANTENNA_PARAMETER_LIST</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;PAX Antenna Setting BLK </span><span class="si">%u</span><span class="s2"> failed&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/hal/phNxpNciHal_ext.cc</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/******************************************************************************</span>
 <span class="o">*</span> <span class="n">Function</span>         <span class="n">phNxpNciHal_send_ext_cmd</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">Description</span>      <span class="n">This</span> <span class="n">function</span> <span class="n">send</span> <span class="n">the</span> <span class="n">extension</span> <span class="n">command</span> <span class="n">to</span> <span class="n">NFCC</span><span class="o">.</span> <span class="n">No</span>
 <span class="o">*</span>                  <span class="n">response</span> <span class="ow">is</span> <span class="n">checked</span> <span class="n">by</span> <span class="n">this</span> <span class="n">function</span> <span class="n">but</span> <span class="n">it</span> <span class="n">waits</span> <span class="k">for</span>
 <span class="o">*</span>                  <span class="n">the</span> <span class="n">response</span> <span class="n">to</span> <span class="n">come</span><span class="o">.</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">Returns</span>          <span class="n">Returns</span> <span class="n">NFCSTATUS_SUCCESS</span> <span class="k">if</span> <span class="n">sending</span> <span class="n">cmd</span> <span class="ow">is</span> <span class="n">successful</span> <span class="ow">and</span>
 <span class="o">*</span>                  <span class="n">response</span> <span class="ow">is</span> <span class="n">received</span><span class="o">.</span>
 <span class="o">*</span>
 <span class="o">******************************************************************************/</span>
<span class="n">NFCSTATUS</span> <span class="n">phNxpNciHal_send_ext_cmd</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">uint8_t</span><span class="o">*</span> <span class="n">p_cmd</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">NFCSTATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
  <span class="n">HAL_ENABLE_EXT</span><span class="p">();</span>
  <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">cmd_len</span><span class="p">;</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_cmd_data</span><span class="p">,</span> <span class="n">p_cmd</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">);</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">phNxpNciHal_process_ext_cmd_rsp</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span><span class="p">,</span>
                                           <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_cmd_data</span><span class="p">);</span>
  <span class="n">HAL_DISABLE_EXT</span><span class="p">();</span>

  <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/******************************************************************************</span>
 <span class="o">*</span> <span class="n">Function</span>         <span class="n">phNxpNciHal_process_ext_cmd_rsp</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">Description</span>      <span class="n">This</span> <span class="n">function</span> <span class="n">process</span> <span class="n">the</span> <span class="n">extension</span> <span class="n">command</span> <span class="n">response</span><span class="o">.</span> <span class="n">It</span>
 <span class="o">*</span>                  <span class="n">also</span> <span class="n">checks</span> <span class="n">the</span> <span class="n">received</span> <span class="n">response</span> <span class="n">to</span> <span class="n">expected</span> <span class="n">response</span><span class="o">.</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">Returns</span>          <span class="n">returns</span> <span class="n">NFCSTATUS_SUCCESS</span> <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="k">as</span> <span class="n">expected</span> <span class="k">else</span>
 <span class="o">*</span>                  <span class="n">returns</span> <span class="n">failure</span><span class="o">.</span>
 <span class="o">*</span>
 <span class="o">******************************************************************************/</span>
<span class="n">static</span> <span class="n">NFCSTATUS</span> <span class="n">phNxpNciHal_process_ext_cmd_rsp</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">cmd_len</span><span class="p">,</span>
                                                 <span class="n">uint8_t</span><span class="o">*</span> <span class="n">p_cmd</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">NFCSTATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
  <span class="n">uint16_t</span> <span class="n">data_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="o">/*</span> <span class="n">Create</span> <span class="n">the</span> <span class="n">local</span> <span class="n">semaphore</span> <span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">phNxpNciHal_init_cb_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="p">,</span> <span class="n">NULL</span><span class="p">)</span> <span class="o">!=</span>
      <span class="n">NFCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Create ext_cb_data failed&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>

  <span class="o">/*</span> <span class="n">Send</span> <span class="n">ext</span> <span class="n">command</span> <span class="o">*/</span>
  <span class="n">data_written</span> <span class="o">=</span> <span class="n">phNxpNciHal_write_unlocked</span><span class="p">(</span><span class="n">cmd_len</span><span class="p">,</span> <span class="n">p_cmd</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">data_written</span> <span class="o">!=</span> <span class="n">cmd_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;phNxpNciHal_write failed for hal ext&quot;</span><span class="p">);</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">Start</span> <span class="n">timer</span> <span class="o">*/</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Start</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">,</span> <span class="n">HAL_EXTNS_WRITE_RSP_TIMEOUT</span><span class="p">,</span>
                                 <span class="o">&amp;</span><span class="n">hal_extns_write_rsp_timeout_cb</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Response timer started&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Response timer not started!!!&quot;</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">rsp</span> <span class="o">*/</span>
  <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Waiting after ext cmd sent&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SEM_WAIT</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;p_hal_ext-&gt;ext_cb_data.sem semaphore error&quot;</span><span class="p">);</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">Stop</span> <span class="n">Timer</span> <span class="o">*/</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Stop</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Response timer stopped&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Response timer stop ERROR!!!&quot;</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s2">&quot;153880630&quot;</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">No</span> <span class="n">NTF</span> <span class="n">expected</span> <span class="k">for</span> <span class="n">OMAPI</span> <span class="n">command</span> <span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x2F</span> <span class="o">&amp;&amp;</span> <span class="n">p_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1</span> <span class="o">&amp;&amp;</span> <span class="n">p_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">nci_info</span><span class="o">.</span><span class="n">wait_for_ntf</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="o">/*</span> <span class="n">Start</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">NTF</span><span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">nci_info</span><span class="o">.</span><span class="n">wait_for_ntf</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Start</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">,</span> <span class="n">HAL_EXTNS_WRITE_RSP_TIMEOUT</span><span class="p">,</span>
                                   <span class="o">&amp;</span><span class="n">hal_extns_write_rsp_timeout_cb</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Response timer started&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Response timer not started!!!&quot;</span><span class="p">);</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
      <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SEM_WAIT</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;p_hal_ext-&gt;ext_cb_data.sem semaphore error&quot;</span><span class="p">);</span>
      <span class="o">/*</span> <span class="n">Stop</span> <span class="n">Timer</span> <span class="o">*/</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Stop</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">);</span>
      <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Stop</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Response timer stopped&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Response timer stop ERROR!!!&quot;</span><span class="p">);</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
      <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">NFCSTATUS_SUCCESS</span> <span class="o">&amp;&amp;</span>
      <span class="n">p_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x2F</span> <span class="o">&amp;&amp;</span> <span class="n">p_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x1</span> <span class="o">&amp;&amp;</span> <span class="n">p_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span>
        <span class="s2">&quot;Callback Status is failed!! Timer Expired!! Couldn&#39;t read it! 0x</span><span class="si">%x</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="o">.</span><span class="n">status</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Checking response&quot;</span><span class="p">);</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>

<span class="n">clean_and_return</span><span class="p">:</span>
  <span class="n">phNxpNciHal_cleanup_cb_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="p">);</span>
  <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">nci_info</span><span class="o">.</span><span class="n">wait_for_ntf</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/hal/phNxpNciHal.cc</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/******************************************************************************</span>
 <span class="o">*</span> <span class="n">Function</span>         <span class="n">phNxpNciHal_write_unlocked</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">Description</span>      <span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">function</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">being</span> <span class="n">called</span> <span class="n">by</span>
 <span class="o">*</span>                  <span class="n">phNxpNciHal_write</span><span class="o">.</span> <span class="n">This</span> <span class="n">function</span> <span class="n">writes</span> <span class="n">the</span> <span class="n">data</span> <span class="n">to</span> <span class="n">NFCC</span><span class="o">.</span>
 <span class="o">*</span>                  <span class="n">It</span> <span class="n">waits</span> <span class="n">till</span> <span class="n">write</span> <span class="n">callback</span> <span class="n">provide</span> <span class="n">the</span> <span class="n">result</span> <span class="n">of</span> <span class="n">write</span>
 <span class="o">*</span>                  <span class="n">process</span><span class="o">.</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">Returns</span>          <span class="n">It</span> <span class="n">returns</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">successfully</span> <span class="n">written</span> <span class="n">to</span> <span class="n">NFCC</span><span class="o">.</span>
 <span class="o">*</span>
 <span class="o">******************************************************************************/</span>
<span class="nb">int</span> <span class="n">phNxpNciHal_write_unlocked</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">const</span> <span class="n">uint8_t</span><span class="o">*</span> <span class="n">p_data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">NFCSTATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_INVALID_PARAMETER</span><span class="p">;</span>
  <span class="n">phNxpNciHal_Sem_t</span> <span class="n">cb_data</span><span class="p">;</span>
  <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">static</span> <span class="n">uint8_t</span> <span class="n">reset_ntf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
                                <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
  <span class="o">/*</span> <span class="n">Create</span> <span class="n">the</span> <span class="n">local</span> <span class="n">semaphore</span> <span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">phNxpNciHal_init_cb_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb_data</span><span class="p">,</span> <span class="n">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;phNxpNciHal_write_unlocked Create cb data failed&quot;</span><span class="p">);</span>
    <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">Create</span> <span class="n">local</span> <span class="n">copy</span> <span class="n">of</span> <span class="n">cmd_data</span> <span class="o">*/</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_cmd_data</span><span class="p">,</span> <span class="n">p_data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
  <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>

  <span class="o">/*</span> <span class="n">check</span> <span class="k">for</span> <span class="n">write</span> <span class="n">synchronyztion</span> <span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">phNxpNciHal_check_ncicmd_write_window</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span><span class="p">,</span>
                                            <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_cmd_data</span><span class="p">)</span> <span class="o">!=</span>
      <span class="n">NFCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;phNxpNciHal_write_unlocked check nci write window failed&quot;</span><span class="p">);</span>
    <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">NfccPowerTracker</span><span class="p">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">.</span><span class="n">ProcessCmd</span><span class="p">(</span>
      <span class="p">(</span><span class="n">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_cmd_data</span><span class="p">,</span> <span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span><span class="p">);</span>

<span class="n">retry</span><span class="p">:</span>

  <span class="n">data_len</span> <span class="o">=</span> <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span><span class="p">;</span>

  <span class="n">status</span> <span class="o">=</span> <span class="n">phTmlNfc_Write</span><span class="p">(</span>
      <span class="p">(</span><span class="n">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_cmd_data</span><span class="p">,</span> <span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span><span class="p">,</span>
      <span class="p">(</span><span class="n">pphTmlNfc_TransactCompletionCb_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phNxpNciHal_write_complete</span><span class="p">,</span>
      <span class="p">(</span><span class="n">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cb_data</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">NFCSTATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;write_unlocked status error&quot;</span><span class="p">);</span>
    <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">callback</span> <span class="n">response</span> <span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SEM_WAIT</span><span class="p">(</span><span class="n">cb_data</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;write_unlocked semaphore error&quot;</span><span class="p">);</span>
    <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">cb_data</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">retry_cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span>
          <span class="s2">&quot;write_unlocked failed - PN54X Maybe in Standby Mode - Retry&quot;</span><span class="p">);</span>
      <span class="o">/*</span> <span class="mi">10</span><span class="n">ms</span> <span class="n">delay</span> <span class="n">to</span> <span class="n">give</span> <span class="n">NFCC</span> <span class="n">wake</span> <span class="n">up</span> <span class="n">delay</span> <span class="o">*/</span>
      <span class="n">usleep</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
      <span class="n">goto</span> <span class="n">retry</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span>
          <span class="s2">&quot;write_unlocked failed - PN54X Maybe in Standby Mode (max count = &quot;</span>
          <span class="s2">&quot;0x</span><span class="si">%x</span><span class="s2">)&quot;</span><span class="p">,</span>
          <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">retry_cnt</span><span class="p">);</span>

      <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">syncSpiNfc</span><span class="p">));</span>

      <span class="n">status</span> <span class="o">=</span> <span class="n">phTmlNfc_IoCtl</span><span class="p">(</span><span class="n">phTmlNfc_e_ResetDevice</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;PN54X Reset - SUCCESS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;PN54X Reset - FAILED</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_nfc_stack_data_cback</span> <span class="o">!=</span> <span class="n">NULL</span> <span class="o">&amp;&amp;</span>
          <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_rx_data</span> <span class="o">!=</span> <span class="n">NULL</span> <span class="o">&amp;&amp;</span>
          <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">hal_open_status</span> <span class="o">==</span> <span class="n">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span>
            <span class="s2">&quot;Send the Core Reset NTF to upper layer, which will trigger the &quot;</span>
            <span class="s2">&quot;recovery</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
        <span class="o">//</span> <span class="n">Send</span> <span class="n">the</span> <span class="n">Core</span> <span class="n">Reset</span> <span class="n">NTF</span> <span class="n">to</span> <span class="n">upper</span> <span class="n">layer</span><span class="p">,</span> <span class="n">which</span> <span class="n">will</span> <span class="n">trigger</span> <span class="n">the</span>
        <span class="o">//</span> <span class="n">recovery</span><span class="o">.</span>
        <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">rx_data_len</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">reset_ntf</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_rx_data</span><span class="p">,</span> <span class="n">reset_ntf</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">reset_ntf</span><span class="p">));</span>
        <span class="p">(</span><span class="o">*</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_nfc_stack_data_cback</span><span class="p">)(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">rx_data_len</span><span class="p">,</span>
                                                 <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_rx_data</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="n">clean_and_return</span><span class="p">:</span>
  <span class="n">phNxpNciHal_cleanup_cb_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb_data</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">data_len</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/tml/phTmlNfc.cc</p></li>
</ul>
<p>注意pTmlWriteComplete 这里有callback调用</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>NFCSTATUS phTmlNfc_Write(uint8_t* pBuffer, uint16_t wLength,
                         pphTmlNfc_TransactCompletionCb_t pTmlWriteComplete,
                         void* pContext) {
  NFCSTATUS wWriteStatus;

  /* Check whether TML is Initialized */

  if (NULL != gpphTmlNfc_Context) {
    if ((NULL != gpphTmlNfc_Context-&gt;pDevHandle) &amp;&amp; (NULL != pBuffer) &amp;&amp;
        (PH_TMLNFC_RESET_VALUE != wLength) &amp;&amp; (NULL != pTmlWriteComplete)) {
      if (!gpphTmlNfc_Context-&gt;tWriteInfo.bThreadBusy) {
        /* Setting the flag marks beginning of a Write Operation */
        gpphTmlNfc_Context-&gt;tWriteInfo.bThreadBusy = true;
        /* Copy the buffer, length and Callback function,
           This shall be utilized while invoking the Callback function in thread
           */
        gpphTmlNfc_Context-&gt;tWriteInfo.pBuffer = pBuffer;
        gpphTmlNfc_Context-&gt;tWriteInfo.wLength = wLength;
        gpphTmlNfc_Context-&gt;tWriteInfo.pThread_Callback = pTmlWriteComplete;
        gpphTmlNfc_Context-&gt;tWriteInfo.pContext = pContext;

        wWriteStatus = NFCSTATUS_PENDING;
        // FIXME: If retry is going on. Stop the retry thread/timer
        if (phTmlNfc_e_EnableRetrans == gpphTmlNfc_Context-&gt;eConfig) {
          /* Set retry count to default value */
          // FIXME: If the timer expired there, and meanwhile we have created
          // a new request. The expired timer will think that retry is still
          // ongoing.
          bCurrentRetryCount = gpphTmlNfc_Context-&gt;bRetryCount;
          gpphTmlNfc_Context-&gt;bWriteCbInvoked = false;
        }
        /* Set event to invoke Writer Thread */
        gpphTmlNfc_Context-&gt;tWriteInfo.bEnable = 1;
        sem_post(&amp;gpphTmlNfc_Context-&gt;txSemaphore);
      } else {
        wWriteStatus = PHNFCSTVAL(CID_NFC_TML, NFCSTATUS_BUSY);
      }
    } else {
      wWriteStatus = PHNFCSTVAL(CID_NFC_TML, NFCSTATUS_INVALID_PARAMETER);
    }
  } else {
    wWriteStatus = PHNFCSTVAL(CID_NFC_TML, NFCSTATUS_NOT_INITIALISED);
  }

  return wWriteStatus;
}
</pre></div>
</div>
<p>调用到写nci指令进程</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">void</span><span class="o">*</span> <span class="n">phTmlNfc_TmlWriterThread</span><span class="p">(</span><span class="n">void</span><span class="o">*</span> <span class="n">pParam</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">NFCSTATUS</span> <span class="n">wStatus</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>
  <span class="n">int32_t</span> <span class="n">dwNoBytesWrRd</span> <span class="o">=</span> <span class="n">PH_TMLNFC_RESET_VALUE</span><span class="p">;</span>
  <span class="o">/*</span> <span class="n">Transaction</span> <span class="n">info</span> <span class="n">buffer</span> <span class="n">to</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">to</span> <span class="n">Callback</span> <span class="n">Thread</span> <span class="o">*/</span>
  <span class="n">static</span> <span class="n">phTmlNfc_TransactInfo_t</span> <span class="n">tTransactionInfo</span><span class="p">;</span>
  <span class="o">/*</span> <span class="n">Structure</span> <span class="n">containing</span> <span class="n">Tml</span> <span class="n">callback</span> <span class="n">function</span> <span class="ow">and</span> <span class="n">parameters</span> <span class="n">to</span> <span class="n">be</span> <span class="n">invoked</span>
     <span class="n">by</span> <span class="n">the</span> <span class="n">callback</span> <span class="n">thread</span> <span class="o">*/</span>
  <span class="n">static</span> <span class="n">phLibNfc_DeferredCall_t</span> <span class="n">tDeferredInfo</span><span class="p">;</span>
  <span class="o">/*</span> <span class="n">Initialize</span> <span class="n">Message</span> <span class="n">structure</span> <span class="n">to</span> <span class="n">post</span> <span class="n">message</span> <span class="n">onto</span> <span class="n">Callback</span> <span class="n">Thread</span> <span class="o">*/</span>
  <span class="n">static</span> <span class="n">phLibNfc_Message_t</span> <span class="n">tMsg</span><span class="p">;</span>
  <span class="o">/*</span> <span class="n">In</span> <span class="n">case</span> <span class="n">of</span> <span class="n">I2C</span> <span class="n">Write</span> <span class="n">Retry</span> <span class="o">*/</span>
  <span class="n">static</span> <span class="n">uint16_t</span> <span class="n">retry_cnt</span><span class="p">;</span>
  <span class="n">UNUSED</span><span class="p">(</span><span class="n">pParam</span><span class="p">);</span>
  <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Tml Writer Thread Started................</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>

  <span class="o">/*</span> <span class="n">Writer</span> <span class="n">thread</span> <span class="n">loop</span> <span class="n">shall</span> <span class="n">be</span> <span class="n">running</span> <span class="n">till</span> <span class="n">shutdown</span> <span class="ow">is</span> <span class="n">invoked</span> <span class="o">*/</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">bThreadDone</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Tml Writer Thread Running................</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">txSemaphore</span><span class="p">);</span>
    <span class="o">/*</span> <span class="n">If</span> <span class="n">Tml</span> <span class="n">write</span> <span class="ow">is</span> <span class="n">requested</span> <span class="o">*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">bEnable</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Write requested.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
      <span class="o">/*</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">to</span> <span class="n">success</span> <span class="n">initially</span> <span class="o">*/</span>
      <span class="n">wStatus</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">NULL</span> <span class="o">!=</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">pDevHandle</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">retry</span><span class="p">:</span>
        <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="o">/*</span> <span class="n">Variable</span> <span class="n">to</span> <span class="n">fetch</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">written</span> <span class="o">*/</span>
        <span class="n">dwNoBytesWrRd</span> <span class="o">=</span> <span class="n">PH_TMLNFC_RESET_VALUE</span><span class="p">;</span>
        <span class="o">/*</span> <span class="n">Write</span> <span class="n">the</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">buffer</span> <span class="n">onto</span> <span class="n">the</span> <span class="n">file</span> <span class="o">*/</span>
        <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Invoking I2C Write.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
        <span class="n">dwNoBytesWrRd</span> <span class="o">=</span>
            <span class="n">gpTransportObj</span><span class="o">-&gt;</span><span class="n">Write</span><span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">pDevHandle</span><span class="p">,</span>
                                  <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">pBuffer</span><span class="p">,</span>
                                  <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">wLength</span><span class="p">);</span>

        <span class="o">/*</span> <span class="n">Try</span> <span class="n">I2C</span> <span class="n">Write</span> <span class="n">Five</span> <span class="n">Times</span><span class="p">,</span> <span class="k">if</span> <span class="n">it</span> <span class="n">fails</span> <span class="p">:</span> <span class="n">Raju</span> <span class="o">*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">dwNoBytesWrRd</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">gpTransportObj</span><span class="o">-&gt;</span><span class="n">IsFwDnldModeEnabled</span><span class="p">()</span> <span class="o">==</span> <span class="n">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">retry_cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">MAX_WRITE_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Error in I2C Write  - Retry 0x</span><span class="si">%x</span><span class="s2">&quot;</span><span class="p">,</span>
                           <span class="n">retry_cnt</span><span class="p">);</span>
              <span class="o">//</span> <span class="n">Add</span> <span class="n">a</span> <span class="mi">10</span> <span class="n">ms</span> <span class="n">delay</span> <span class="n">to</span> <span class="n">ensure</span> <span class="n">NFCC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">still</span> <span class="ow">in</span> <span class="n">stand</span> <span class="n">by</span> <span class="n">mode</span><span class="o">.</span>
              <span class="n">usleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
              <span class="n">goto</span> <span class="n">retry</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Error in I2C Write.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
          <span class="n">wStatus</span> <span class="o">=</span> <span class="n">PHNFCSTVAL</span><span class="p">(</span><span class="n">CID_NFC_TML</span><span class="p">,</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">phNxpNciHal_print_packet</span><span class="p">(</span><span class="s2">&quot;SEND&quot;</span><span class="p">,</span>
                                   <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">pBuffer</span><span class="p">,</span>
                                   <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">wLength</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">wStatus</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - I2C Write successful.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
          <span class="n">dwNoBytesWrRd</span> <span class="o">=</span> <span class="n">PH_TMLNFC_VALUE_ONE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="o">/*</span> <span class="n">Fill</span> <span class="n">the</span> <span class="n">Transaction</span> <span class="n">info</span> <span class="n">structure</span> <span class="n">to</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">to</span> <span class="n">Callback</span> <span class="n">Function</span>
         <span class="o">*/</span>
        <span class="n">tTransactionInfo</span><span class="o">.</span><span class="n">wStatus</span> <span class="o">=</span> <span class="n">wStatus</span><span class="p">;</span>
        <span class="n">tTransactionInfo</span><span class="o">.</span><span class="n">pBuff</span> <span class="o">=</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">pBuffer</span><span class="p">;</span>
        <span class="o">/*</span> <span class="n">Actual</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">written</span> <span class="ow">is</span> <span class="n">filled</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">structure</span> <span class="o">*/</span>
        <span class="n">tTransactionInfo</span><span class="o">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span><span class="n">dwNoBytesWrRd</span><span class="p">;</span>

        <span class="o">/*</span> <span class="n">Prepare</span> <span class="n">the</span> <span class="n">message</span> <span class="n">to</span> <span class="n">be</span> <span class="n">posted</span> <span class="n">on</span> <span class="n">the</span> <span class="n">User</span> <span class="n">thread</span> <span class="o">*/</span>
        <span class="n">tDeferredInfo</span><span class="o">.</span><span class="n">pCallback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phTmlNfc_WriteDeferredCb</span><span class="p">;</span>
        <span class="n">tDeferredInfo</span><span class="o">.</span><span class="n">pParameter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tTransactionInfo</span><span class="p">;</span>
        <span class="o">/*</span> <span class="n">Write</span> <span class="n">operation</span> <span class="n">completed</span> <span class="n">successfully</span><span class="o">.</span> <span class="n">Post</span> <span class="n">a</span> <span class="n">Message</span> <span class="n">onto</span> <span class="n">Callback</span>
         <span class="o">*</span> <span class="n">Thread</span><span class="o">*/</span>
        <span class="n">tMsg</span><span class="o">.</span><span class="n">eMsgType</span> <span class="o">=</span> <span class="n">PH_LIBNFC_DEFERREDCALL_MSG</span><span class="p">;</span>
        <span class="n">tMsg</span><span class="o">.</span><span class="n">pMsgData</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tDeferredInfo</span><span class="p">;</span>
        <span class="n">tMsg</span><span class="o">.</span><span class="n">Size</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">tDeferredInfo</span><span class="p">);</span>

        <span class="o">/*</span> <span class="n">Check</span> <span class="n">whether</span> <span class="n">Retransmission</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">started</span><span class="p">,</span>
         <span class="o">*</span> <span class="n">If</span> <span class="n">yes</span><span class="p">,</span> <span class="n">Post</span> <span class="n">message</span> <span class="n">only</span> <span class="k">if</span>
         <span class="o">*</span> <span class="n">case</span> <span class="mf">1.</span> <span class="n">Message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">posted</span> <span class="o">&amp;&amp;</span>
         <span class="o">*</span> <span class="n">case</span> <span class="mf">11.</span> <span class="n">Write</span> <span class="n">status</span> <span class="ow">is</span> <span class="n">success</span> <span class="o">||</span>
         <span class="o">*</span> <span class="n">case</span> <span class="mf">12.</span> <span class="n">Last</span> <span class="n">retry</span> <span class="n">of</span> <span class="n">write</span> <span class="ow">is</span> <span class="n">also</span> <span class="n">failure</span>
         <span class="o">*/</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">phTmlNfc_e_EnableRetrans</span> <span class="o">==</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">eConfig</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="mh">0x00</span> <span class="o">!=</span> <span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">pBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">)))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">bWriteCbInvoked</span> <span class="o">==</span> <span class="n">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">wStatus</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">bCurrentRetryCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
              <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Posting Write message.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
              <span class="n">phTmlNfc_DeferredCall</span><span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">dwCallbackThreadId</span><span class="p">,</span>
                                    <span class="o">&amp;</span><span class="n">tMsg</span><span class="p">);</span>
              <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">bWriteCbInvoked</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Posting Fresh Write message.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
          <span class="n">phTmlNfc_DeferredCall</span><span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">dwCallbackThreadId</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tMsg</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - gpphTmlNfc_Context-&gt;pDevHandle is NULL&quot;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="o">/*</span> <span class="n">If</span> <span class="n">Data</span> <span class="n">packet</span> <span class="ow">is</span> <span class="n">sent</span><span class="p">,</span> <span class="n">then</span> <span class="n">NO</span> <span class="n">retransmission</span> <span class="o">*/</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">phTmlNfc_e_EnableRetrans</span> <span class="o">==</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">eConfig</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="mh">0x00</span> <span class="o">!=</span> <span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">pBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Starting timer for Retransmission case&quot;</span><span class="p">);</span>
        <span class="n">wStatus</span> <span class="o">=</span> <span class="n">phTmlNfc_InitiateTimer</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">!=</span> <span class="n">wStatus</span><span class="p">)</span> <span class="p">{</span>
          <span class="o">/*</span> <span class="n">Reset</span> <span class="n">Variables</span> <span class="n">used</span> <span class="k">for</span> <span class="n">Retransmission</span> <span class="o">*/</span>
          <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Retransmission timer initiate failed&quot;</span><span class="p">);</span>
          <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">bCurrentRetryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Write request NOT enabled&quot;</span><span class="p">);</span>
      <span class="n">usleep</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">}</span> <span class="o">/*</span> <span class="n">End</span> <span class="n">of</span> <span class="n">While</span> <span class="n">loop</span> <span class="o">*/</span>

  <span class="k">return</span> <span class="n">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/kernel/msm-4.19/drivers/misc/pax/nfc/pn7160/i2c_drv.c</p></li>
</ul>
<p>调用的写的文件,/dev/nxpnfc</p>
<p>第一个配置文件下的参数,20022905A00D047242F840A00D06724A0007001BA00D03721601A00D063C44660A0000A00D063C2DDC400400</p>
<p>2002代表,CORE_SET_CONFIG_CMD</p>
<p>29 代表 0x29 = 41 个数据长度</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssize_t</span> <span class="n">nfc_i2c_dev_write</span><span class="p">(</span><span class="n">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			  <span class="n">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nb">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">struct</span> <span class="n">nfc_dev</span> <span class="o">*</span><span class="n">nfc_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span> <span class="n">nfc_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_DL_BUFFER_SIZE</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">MAX_DL_BUFFER_SIZE</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfc_dev</span><span class="o">-&gt;</span><span class="n">write_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">nfc_dev</span><span class="o">-&gt;</span><span class="n">write_kbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: failed to copy from user space</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfc_dev</span><span class="o">-&gt;</span><span class="n">write_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_printf</span><span class="p">(</span><span class="n">nfc_dev</span><span class="o">-&gt;</span><span class="n">write_kbuf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_write</span><span class="p">(</span><span class="n">nfc_dev</span><span class="p">,</span> <span class="n">nfc_dev</span><span class="o">-&gt;</span><span class="n">write_kbuf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">NO_RETRY</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfc_dev</span><span class="o">-&gt;</span><span class="n">write_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/tml/phTmlNfc.cc</p></li>
</ul>
<p>驱动写完后,回调到phNxpNciHal_print_packet(“SEND”,
gpphTmlNfc_Context-&gt;tWriteInfo.pBuffer,
gpphTmlNfc_Context-&gt;tWriteInfo.wLength);</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">void</span><span class="o">*</span> <span class="n">phTmlNfc_TmlWriterThread</span><span class="p">(</span><span class="n">void</span><span class="o">*</span> <span class="n">pParam</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Invoking I2C Write.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
        <span class="n">dwNoBytesWrRd</span> <span class="o">=</span>
            <span class="n">gpTransportObj</span><span class="o">-&gt;</span><span class="n">Write</span><span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">pDevHandle</span><span class="p">,</span>
                                  <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">pBuffer</span><span class="p">,</span>
                                  <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">wLength</span><span class="p">);</span>

        <span class="o">/*</span> <span class="n">Try</span> <span class="n">I2C</span> <span class="n">Write</span> <span class="n">Five</span> <span class="n">Times</span><span class="p">,</span> <span class="k">if</span> <span class="n">it</span> <span class="n">fails</span> <span class="p">:</span> <span class="n">Raju</span> <span class="o">*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">dwNoBytesWrRd</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">gpTransportObj</span><span class="o">-&gt;</span><span class="n">IsFwDnldModeEnabled</span><span class="p">()</span> <span class="o">==</span> <span class="n">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">retry_cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">MAX_WRITE_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Error in I2C Write  - Retry 0x</span><span class="si">%x</span><span class="s2">&quot;</span><span class="p">,</span>
                           <span class="n">retry_cnt</span><span class="p">);</span>
              <span class="o">//</span> <span class="n">Add</span> <span class="n">a</span> <span class="mi">10</span> <span class="n">ms</span> <span class="n">delay</span> <span class="n">to</span> <span class="n">ensure</span> <span class="n">NFCC</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">still</span> <span class="ow">in</span> <span class="n">stand</span> <span class="n">by</span> <span class="n">mode</span><span class="o">.</span>
              <span class="n">usleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
              <span class="n">goto</span> <span class="n">retry</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Error in I2C Write.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
          <span class="n">wStatus</span> <span class="o">=</span> <span class="n">PHNFCSTVAL</span><span class="p">(</span><span class="n">CID_NFC_TML</span><span class="p">,</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">phNxpNciHal_print_packet</span><span class="p">(</span><span class="s2">&quot;SEND&quot;</span><span class="p">,</span>
                                   <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">pBuffer</span><span class="p">,</span>
                                   <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">wLength</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">wStatus</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - I2C Write successful.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
          <span class="n">dwNoBytesWrRd</span> <span class="o">=</span> <span class="n">PH_TMLNFC_VALUE_ONE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="o">/*</span> <span class="n">Fill</span> <span class="n">the</span> <span class="n">Transaction</span> <span class="n">info</span> <span class="n">structure</span> <span class="n">to</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">to</span> <span class="n">Callback</span> <span class="n">Function</span>
         <span class="o">*/</span>
        <span class="n">tTransactionInfo</span><span class="o">.</span><span class="n">wStatus</span> <span class="o">=</span> <span class="n">wStatus</span><span class="p">;</span>
        <span class="n">tTransactionInfo</span><span class="o">.</span><span class="n">pBuff</span> <span class="o">=</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">pBuffer</span><span class="p">;</span>
        <span class="o">/*</span> <span class="n">Actual</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">written</span> <span class="ow">is</span> <span class="n">filled</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">structure</span> <span class="o">*/</span>
        <span class="n">tTransactionInfo</span><span class="o">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span><span class="n">dwNoBytesWrRd</span><span class="p">;</span>

        <span class="o">/*</span> <span class="n">Prepare</span> <span class="n">the</span> <span class="n">message</span> <span class="n">to</span> <span class="n">be</span> <span class="n">posted</span> <span class="n">on</span> <span class="n">the</span> <span class="n">User</span> <span class="n">thread</span> <span class="o">*/</span>
        <span class="n">tDeferredInfo</span><span class="o">.</span><span class="n">pCallback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phTmlNfc_WriteDeferredCb</span><span class="p">;</span>
        <span class="n">tDeferredInfo</span><span class="o">.</span><span class="n">pParameter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tTransactionInfo</span><span class="p">;</span>
        <span class="o">/*</span> <span class="n">Write</span> <span class="n">operation</span> <span class="n">completed</span> <span class="n">successfully</span><span class="o">.</span> <span class="n">Post</span> <span class="n">a</span> <span class="n">Message</span> <span class="n">onto</span> <span class="n">Callback</span>
         <span class="o">*</span> <span class="n">Thread</span><span class="o">*/</span>
        <span class="n">tMsg</span><span class="o">.</span><span class="n">eMsgType</span> <span class="o">=</span> <span class="n">PH_LIBNFC_DEFERREDCALL_MSG</span><span class="p">;</span>
        <span class="n">tMsg</span><span class="o">.</span><span class="n">pMsgData</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tDeferredInfo</span><span class="p">;</span>
        <span class="n">tMsg</span><span class="o">.</span><span class="n">Size</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">tDeferredInfo</span><span class="p">);</span>

        <span class="o">/*</span> <span class="n">Check</span> <span class="n">whether</span> <span class="n">Retransmission</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">started</span><span class="p">,</span>
         <span class="o">*</span> <span class="n">If</span> <span class="n">yes</span><span class="p">,</span> <span class="n">Post</span> <span class="n">message</span> <span class="n">only</span> <span class="k">if</span>
         <span class="o">*</span> <span class="n">case</span> <span class="mf">1.</span> <span class="n">Message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">posted</span> <span class="o">&amp;&amp;</span>
         <span class="o">*</span> <span class="n">case</span> <span class="mf">11.</span> <span class="n">Write</span> <span class="n">status</span> <span class="ow">is</span> <span class="n">success</span> <span class="o">||</span>
         <span class="o">*</span> <span class="n">case</span> <span class="mf">12.</span> <span class="n">Last</span> <span class="n">retry</span> <span class="n">of</span> <span class="n">write</span> <span class="ow">is</span> <span class="n">also</span> <span class="n">failure</span>
         <span class="o">*/</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">phTmlNfc_e_EnableRetrans</span> <span class="o">==</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">eConfig</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="mh">0x00</span> <span class="o">!=</span> <span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">pBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">)))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">bWriteCbInvoked</span> <span class="o">==</span> <span class="n">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">wStatus</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">bCurrentRetryCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
              <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Posting Write message.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
              <span class="n">phTmlNfc_DeferredCall</span><span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">dwCallbackThreadId</span><span class="p">,</span>
                                    <span class="o">&amp;</span><span class="n">tMsg</span><span class="p">);</span>
              <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">bWriteCbInvoked</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Posting Fresh Write message.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
          <span class="n">phTmlNfc_DeferredCall</span><span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">dwCallbackThreadId</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tMsg</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - gpphTmlNfc_Context-&gt;pDevHandle is NULL&quot;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="o">/*</span> <span class="n">If</span> <span class="n">Data</span> <span class="n">packet</span> <span class="ow">is</span> <span class="n">sent</span><span class="p">,</span> <span class="n">then</span> <span class="n">NO</span> <span class="n">retransmission</span> <span class="o">*/</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">phTmlNfc_e_EnableRetrans</span> <span class="o">==</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">eConfig</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="mh">0x00</span> <span class="o">!=</span> <span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">pBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Starting timer for Retransmission case&quot;</span><span class="p">);</span>
        <span class="n">wStatus</span> <span class="o">=</span> <span class="n">phTmlNfc_InitiateTimer</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">!=</span> <span class="n">wStatus</span><span class="p">)</span> <span class="p">{</span>
          <span class="o">/*</span> <span class="n">Reset</span> <span class="n">Variables</span> <span class="n">used</span> <span class="k">for</span> <span class="n">Retransmission</span> <span class="o">*/</span>
          <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Retransmission timer initiate failed&quot;</span><span class="p">);</span>
          <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">bCurrentRetryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Write request NOT enabled&quot;</span><span class="p">);</span>
      <span class="n">usleep</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">}</span> <span class="o">/*</span> <span class="n">End</span> <span class="n">of</span> <span class="n">While</span> <span class="n">loop</span> <span class="o">*/</span>

<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>写完后,callback 流程</p>
<ul>
<li><p>phTmlNfc_TmlWriterThread -&gt; PH_LIBNFC_DEFERREDCALL_MSG -&gt; phTmlNfc_DeferredCall</p></li>
</ul>
</li>
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/tml/phTmlNfc.cc</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">phTmlNfc_DeferredCall</span><span class="p">(</span><span class="n">uintptr_t</span> <span class="n">dwThreadId</span><span class="p">,</span>
                           <span class="n">phLibNfc_Message_t</span><span class="o">*</span> <span class="n">ptWorkerMsg</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">intptr_t</span> <span class="n">bPostStatus</span><span class="p">;</span>
  <span class="n">UNUSED</span><span class="p">(</span><span class="n">dwThreadId</span><span class="p">);</span>
  <span class="o">/*</span> <span class="n">Post</span> <span class="n">message</span> <span class="n">on</span> <span class="n">the</span> <span class="n">user</span> <span class="n">thread</span> <span class="n">to</span> <span class="n">invoke</span> <span class="n">the</span> <span class="n">callback</span> <span class="n">function</span> <span class="o">*/</span>
  <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">postMsgSemaphore</span><span class="p">);</span>
  <span class="n">bPostStatus</span> <span class="o">=</span>
      <span class="n">phDal4Nfc_msgsnd</span><span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">dwCallbackThreadId</span><span class="p">,</span> <span class="n">ptWorkerMsg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">postMsgSemaphore</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/tml/phDal4Nfc_messageQueueLib.cc</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">intptr_t</span> <span class="n">phDal4Nfc_msgsnd</span><span class="p">(</span><span class="n">intptr_t</span> <span class="n">msqid</span><span class="p">,</span> <span class="n">phLibNfc_Message_t</span><span class="o">*</span> <span class="n">msg</span><span class="p">,</span> <span class="nb">int</span> <span class="n">msgflg</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">phDal4Nfc_message_queue_t</span><span class="o">*</span> <span class="n">pQueue</span><span class="p">;</span>
  <span class="n">phDal4Nfc_message_queue_item_t</span><span class="o">*</span> <span class="n">p</span><span class="p">;</span>
  <span class="n">phDal4Nfc_message_queue_item_t</span><span class="o">*</span> <span class="n">pNew</span><span class="p">;</span>
  <span class="n">UNUSED</span><span class="p">(</span><span class="n">msgflg</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">msqid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> 

  <span class="n">pQueue</span> <span class="o">=</span> <span class="p">(</span><span class="n">phDal4Nfc_message_queue_t</span><span class="o">*</span><span class="p">)</span><span class="n">msqid</span><span class="p">;</span>
  <span class="n">pNew</span> <span class="o">=</span> <span class="p">(</span><span class="n">phDal4Nfc_message_queue_item_t</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span>
      <span class="n">sizeof</span><span class="p">(</span><span class="n">phDal4Nfc_message_queue_item_t</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pNew</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> 
  <span class="n">memset</span><span class="p">(</span><span class="n">pNew</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">phDal4Nfc_message_queue_item_t</span><span class="p">));</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pNew</span><span class="o">-&gt;</span><span class="n">nMsg</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">phLibNfc_Message_t</span><span class="p">));</span>
  <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pQueue</span><span class="o">-&gt;</span><span class="n">nCriticalSectionMutex</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">pQueue</span><span class="o">-&gt;</span><span class="n">pItems</span> <span class="o">!=</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pQueue</span><span class="o">-&gt;</span><span class="n">pItems</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pNext</span> <span class="o">!=</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pNext</span><span class="p">;</span>
    <span class="p">}</span>   
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">pNext</span> <span class="o">=</span> <span class="n">pNew</span><span class="p">;</span>
    <span class="n">pNew</span><span class="o">-&gt;</span><span class="n">pPrev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">pQueue</span><span class="o">-&gt;</span><span class="n">pItems</span> <span class="o">=</span> <span class="n">pNew</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pQueue</span><span class="o">-&gt;</span><span class="n">nCriticalSectionMutex</span><span class="p">);</span>

  <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pQueue</span><span class="o">-&gt;</span><span class="n">nProcessSemaphore</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/hal/phNxpNciHal.cc</p></li>
</ul>
<p>所以就回调到  case PH_LIBNFC_DEFERREDCALL_MSG</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">void</span><span class="o">*</span> <span class="n">phNxpNciHal_client_thread</span><span class="p">(</span><span class="n">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">phNxpNciHal_Control_t</span><span class="o">*</span> <span class="n">p_nxpncihal_ctrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">phNxpNciHal_Control_t</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
  <span class="n">phLibNfc_Message_t</span> <span class="n">msg</span><span class="p">;</span>

  <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;thread started&quot;</span><span class="p">);</span>

  <span class="n">p_nxpncihal_ctrl</span><span class="o">-&gt;</span><span class="n">thread_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">p_nxpncihal_ctrl</span><span class="o">-&gt;</span><span class="n">thread_running</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">/*</span> <span class="n">Fetch</span> <span class="nb">next</span> <span class="n">message</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">NFC</span> <span class="n">stack</span> <span class="n">message</span> <span class="n">queue</span> <span class="o">*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">phDal4Nfc_msgrcv</span><span class="p">(</span><span class="n">p_nxpncihal_ctrl</span><span class="o">-&gt;</span><span class="n">gDrvCfg</span><span class="o">.</span><span class="n">nClientId</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;NFC client received bad message&quot;</span><span class="p">);</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">p_nxpncihal_ctrl</span><span class="o">-&gt;</span><span class="n">thread_running</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">switch</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">eMsgType</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">PH_LIBNFC_DEFERREDCALL_MSG</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">phLibNfc_DeferredCall_t</span><span class="o">*</span> <span class="n">deferCall</span> <span class="o">=</span>
            <span class="p">(</span><span class="n">phLibNfc_DeferredCall_t</span><span class="o">*</span><span class="p">)(</span><span class="n">msg</span><span class="o">.</span><span class="n">pMsgData</span><span class="p">);</span>

        <span class="n">REENTRANCE_LOCK</span><span class="p">();</span>
        <span class="n">deferCall</span><span class="o">-&gt;</span><span class="n">pCallback</span><span class="p">(</span><span class="n">deferCall</span><span class="o">-&gt;</span><span class="n">pParameter</span><span class="p">);</span>
        <span class="n">REENTRANCE_UNLOCK</span><span class="p">();</span>

        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>继续回调 pCallback</p>
<ul>
<li><p>tDeferredInfo.pCallback = &amp;phTmlNfc_WriteDeferredCb;</p></li>
</ul>
</li>
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/tml/phTmlNfc.cc</p></li>
</ul>
<p>gpphTmlNfc_Context-&gt;tWriteInfo.pThread_Callback = pTmlWriteComplete;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">void</span> <span class="n">phTmlNfc_WriteDeferredCb</span><span class="p">(</span><span class="n">void</span><span class="o">*</span> <span class="n">pParams</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">/*</span> <span class="n">Transaction</span> <span class="n">info</span> <span class="n">buffer</span> <span class="n">to</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">to</span> <span class="n">Callback</span> <span class="n">Function</span> <span class="o">*/</span>
  <span class="n">phTmlNfc_TransactInfo_t</span><span class="o">*</span> <span class="n">pTransactionInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">phTmlNfc_TransactInfo_t</span><span class="o">*</span><span class="p">)</span><span class="n">pParams</span><span class="p">;</span>

  <span class="o">/*</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">flag</span> <span class="n">to</span> <span class="n">accept</span> <span class="n">another</span> <span class="n">Write</span> <span class="n">Request</span> <span class="o">*/</span>
  <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">bThreadBusy</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
  <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">pThread_Callback</span><span class="p">(</span>
      <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">pContext</span><span class="p">,</span> <span class="n">pTransactionInfo</span><span class="p">);</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>pTmlWriteComplete 就回调到 最开始入参</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NFCSTATUS</span> <span class="n">phTmlNfc_Write</span><span class="p">(</span><span class="n">uint8_t</span><span class="o">*</span> <span class="n">pBuffer</span><span class="p">,</span> <span class="n">uint16_t</span> <span class="n">wLength</span><span class="p">,</span>
                         <span class="n">pphTmlNfc_TransactCompletionCb_t</span> <span class="n">pTmlWriteComplete</span><span class="p">,</span>
                         <span class="n">void</span><span class="o">*</span> <span class="n">pContext</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/hal/phNxpNciHal.cc</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">status</span> <span class="o">=</span> <span class="n">phTmlNfc_Write</span><span class="p">(</span>
      <span class="p">(</span><span class="n">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_cmd_data</span><span class="p">,</span> <span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span><span class="p">,</span>
      <span class="p">(</span><span class="n">pphTmlNfc_TransactCompletionCb_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phNxpNciHal_write_complete</span><span class="p">,</span>
      <span class="p">(</span><span class="n">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cb_data</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">void</span> <span class="n">phNxpNciHal_write_complete</span><span class="p">(</span><span class="n">void</span><span class="o">*</span> <span class="n">pContext</span><span class="p">,</span>
                                       <span class="n">phTmlNfc_TransactInfo_t</span><span class="o">*</span> <span class="n">pInfo</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">phNxpNciHal_Sem_t</span><span class="o">*</span> <span class="n">p_cb_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">phNxpNciHal_Sem_t</span><span class="o">*</span><span class="p">)</span><span class="n">pContext</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">wStatus</span> <span class="o">==</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;write successful status = 0x</span><span class="si">%x</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">wStatus</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;write error status = 0x</span><span class="si">%x</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">wStatus</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">p_cb_data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">wStatus</span><span class="p">;</span>

  <span class="n">SEM_POST</span><span class="p">(</span><span class="n">p_cb_data</span><span class="p">);</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>所以最终是 SEM_POST(p_cb_data); 这个 p_cb_data 就是,cb_data</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">status</span> <span class="o">=</span> <span class="n">phTmlNfc_Write</span><span class="p">(</span>
      <span class="p">(</span><span class="n">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_cmd_data</span><span class="p">,</span> <span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span><span class="p">,</span>
      <span class="p">(</span><span class="n">pphTmlNfc_TransactCompletionCb_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phNxpNciHal_write_complete</span><span class="p">,</span>
      <span class="p">(</span><span class="n">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cb_data</span><span class="p">);</span>
</pre></div>
</div>
<p>所以最终调回 if (SEM_WAIT(cb_data)) {} 这里,继续执行</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">phNxpNciHal_write_unlocked</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">const</span> <span class="n">uint8_t</span><span class="o">*</span> <span class="n">p_data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">NFCSTATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_INVALID_PARAMETER</span><span class="p">;</span>
  <span class="n">phNxpNciHal_Sem_t</span> <span class="n">cb_data</span><span class="p">;</span>
  <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">retry_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">static</span> <span class="n">uint8_t</span> <span class="n">reset_ntf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
                                <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
  <span class="o">/*</span> <span class="n">Create</span> <span class="n">the</span> <span class="n">local</span> <span class="n">semaphore</span> <span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">phNxpNciHal_init_cb_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb_data</span><span class="p">,</span> <span class="n">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;phNxpNciHal_write_unlocked Create cb data failed&quot;</span><span class="p">);</span>
    <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">Create</span> <span class="n">local</span> <span class="n">copy</span> <span class="n">of</span> <span class="n">cmd_data</span> <span class="o">*/</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_cmd_data</span><span class="p">,</span> <span class="n">p_data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
  <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>

  <span class="o">/*</span> <span class="n">check</span> <span class="k">for</span> <span class="n">write</span> <span class="n">synchronyztion</span> <span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">phNxpNciHal_check_ncicmd_write_window</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span><span class="p">,</span>
                                            <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_cmd_data</span><span class="p">)</span> <span class="o">!=</span>
      <span class="n">NFCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;phNxpNciHal_write_unlocked check nci write window failed&quot;</span><span class="p">);</span>
    <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">NfccPowerTracker</span><span class="p">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">.</span><span class="n">ProcessCmd</span><span class="p">(</span>
      <span class="p">(</span><span class="n">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_cmd_data</span><span class="p">,</span> <span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span><span class="p">);</span>

<span class="n">retry</span><span class="p">:</span>

  <span class="n">data_len</span> <span class="o">=</span> <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span><span class="p">;</span>

  <span class="n">status</span> <span class="o">=</span> <span class="n">phTmlNfc_Write</span><span class="p">(</span>
      <span class="p">(</span><span class="n">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_cmd_data</span><span class="p">,</span> <span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span><span class="p">,</span>
      <span class="p">(</span><span class="n">pphTmlNfc_TransactCompletionCb_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phNxpNciHal_write_complete</span><span class="p">,</span>
      <span class="p">(</span><span class="n">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cb_data</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">NFCSTATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;write_unlocked status error&quot;</span><span class="p">);</span>
    <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">callback</span> <span class="n">response</span> <span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SEM_WAIT</span><span class="p">(</span><span class="n">cb_data</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;write_unlocked semaphore error&quot;</span><span class="p">);</span>
    <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">cb_data</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">retry_cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span>
          <span class="s2">&quot;write_unlocked failed - PN54X Maybe in Standby Mode - Retry&quot;</span><span class="p">);</span>
      <span class="o">/*</span> <span class="mi">10</span><span class="n">ms</span> <span class="n">delay</span> <span class="n">to</span> <span class="n">give</span> <span class="n">NFCC</span> <span class="n">wake</span> <span class="n">up</span> <span class="n">delay</span> <span class="o">*/</span>
      <span class="n">usleep</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
      <span class="n">goto</span> <span class="n">retry</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span>
          <span class="s2">&quot;write_unlocked failed - PN54X Maybe in Standby Mode (max count = &quot;</span>
          <span class="s2">&quot;0x</span><span class="si">%x</span><span class="s2">)&quot;</span><span class="p">,</span>
          <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">retry_cnt</span><span class="p">);</span>

      <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">syncSpiNfc</span><span class="p">));</span>

      <span class="n">status</span> <span class="o">=</span> <span class="n">phTmlNfc_IoCtl</span><span class="p">(</span><span class="n">phTmlNfc_e_ResetDevice</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;PN54X Reset - SUCCESS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;PN54X Reset - FAILED</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_nfc_stack_data_cback</span> <span class="o">!=</span> <span class="n">NULL</span> <span class="o">&amp;&amp;</span>
          <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_rx_data</span> <span class="o">!=</span> <span class="n">NULL</span> <span class="o">&amp;&amp;</span>
          <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">hal_open_status</span> <span class="o">==</span> <span class="n">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span>
            <span class="s2">&quot;Send the Core Reset NTF to upper layer, which will trigger the &quot;</span>
            <span class="s2">&quot;recovery</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
        <span class="o">//</span> <span class="n">Send</span> <span class="n">the</span> <span class="n">Core</span> <span class="n">Reset</span> <span class="n">NTF</span> <span class="n">to</span> <span class="n">upper</span> <span class="n">layer</span><span class="p">,</span> <span class="n">which</span> <span class="n">will</span> <span class="n">trigger</span> <span class="n">the</span>
        <span class="o">//</span> <span class="n">recovery</span><span class="o">.</span>
        <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">rx_data_len</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">reset_ntf</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_rx_data</span><span class="p">,</span> <span class="n">reset_ntf</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">reset_ntf</span><span class="p">));</span>
        <span class="p">(</span><span class="o">*</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_nfc_stack_data_cback</span><span class="p">)(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">rx_data_len</span><span class="p">,</span>
                                                 <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_rx_data</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="n">clean_and_return</span><span class="p">:</span>
  <span class="n">phNxpNciHal_cleanup_cb_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb_data</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">data_len</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/hal/phNxpNciHal_ext.cc</p></li>
</ul>
<p>所以最终调回phNxpNciHal_write_unlocked,这里继续执行</p>
<p>启动了一个等待回复的1000ms timer,phOsalNfc_Timer_Start</p>
<p>然后进入等待信号来临SEM_WAIT(nxpncihal_ctrl.ext_cb_data)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">NFCSTATUS</span> <span class="n">phNxpNciHal_process_ext_cmd_rsp</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">cmd_len</span><span class="p">,</span>
                                                 <span class="n">uint8_t</span><span class="o">*</span> <span class="n">p_cmd</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">NFCSTATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
  <span class="n">uint16_t</span> <span class="n">data_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="o">/*</span> <span class="n">Create</span> <span class="n">the</span> <span class="n">local</span> <span class="n">semaphore</span> <span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">phNxpNciHal_init_cb_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="p">,</span> <span class="n">NULL</span><span class="p">)</span> <span class="o">!=</span>
      <span class="n">NFCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Create ext_cb_data failed&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>

  <span class="o">/*</span> <span class="n">Send</span> <span class="n">ext</span> <span class="n">command</span> <span class="o">*/</span>
  <span class="n">data_written</span> <span class="o">=</span> <span class="n">phNxpNciHal_write_unlocked</span><span class="p">(</span><span class="n">cmd_len</span><span class="p">,</span> <span class="n">p_cmd</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">data_written</span> <span class="o">!=</span> <span class="n">cmd_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;phNxpNciHal_write failed for hal ext&quot;</span><span class="p">);</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">Start</span> <span class="n">timer</span> <span class="o">*/</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Start</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">,</span> <span class="n">HAL_EXTNS_WRITE_RSP_TIMEOUT</span><span class="p">,</span>
                                 <span class="o">&amp;</span><span class="n">hal_extns_write_rsp_timeout_cb</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Response timer started&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Response timer not started!!!&quot;</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">rsp</span> <span class="o">*/</span>
  <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Waiting after ext cmd sent&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SEM_WAIT</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;p_hal_ext-&gt;ext_cb_data.sem semaphore error&quot;</span><span class="p">);</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">Stop</span> <span class="n">Timer</span> <span class="o">*/</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Stop</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Response timer stopped&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Response timer stop ERROR!!!&quot;</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s2">&quot;153880630&quot;</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">No</span> <span class="n">NTF</span> <span class="n">expected</span> <span class="k">for</span> <span class="n">OMAPI</span> <span class="n">command</span> <span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x2F</span> <span class="o">&amp;&amp;</span> <span class="n">p_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1</span> <span class="o">&amp;&amp;</span> <span class="n">p_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">nci_info</span><span class="o">.</span><span class="n">wait_for_ntf</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="o">/*</span> <span class="n">Start</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">NTF</span><span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">nci_info</span><span class="o">.</span><span class="n">wait_for_ntf</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Start</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">,</span> <span class="n">HAL_EXTNS_WRITE_RSP_TIMEOUT</span><span class="p">,</span>
                                   <span class="o">&amp;</span><span class="n">hal_extns_write_rsp_timeout_cb</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Response timer started&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Response timer not started!!!&quot;</span><span class="p">);</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
      <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SEM_WAIT</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;p_hal_ext-&gt;ext_cb_data.sem semaphore error&quot;</span><span class="p">);</span>
      <span class="o">/*</span> <span class="n">Stop</span> <span class="n">Timer</span> <span class="o">*/</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Stop</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">);</span>
      <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Stop</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Response timer stopped&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Response timer stop ERROR!!!&quot;</span><span class="p">);</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
      <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">NFCSTATUS_SUCCESS</span> <span class="o">&amp;&amp;</span>
      <span class="n">p_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x2F</span> <span class="o">&amp;&amp;</span> <span class="n">p_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x1</span> <span class="o">&amp;&amp;</span> <span class="n">p_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span>
        <span class="s2">&quot;Callback Status is failed!! Timer Expired!! Couldn&#39;t read it! 0x</span><span class="si">%x</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="o">.</span><span class="n">status</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Checking response&quot;</span><span class="p">);</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>

<span class="n">clean_and_return</span><span class="p">:</span>
  <span class="n">phNxpNciHal_cleanup_cb_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="p">);</span>
  <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">nci_info</span><span class="o">.</span><span class="n">wait_for_ntf</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/kernel/msm-4.19/drivers/misc/pax/nfc/pn7160/i2c_drv.c</p></li>
</ul>
<p>上层进入等待芯片回复信号,芯片高电平中断来临,上层read两次的原因是,有的命令不止有rsp,还有ntf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">irqreturn_t</span> <span class="n">i2c_irq_handler</span><span class="p">(</span><span class="nb">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">struct</span> <span class="n">nfc_dev</span> <span class="o">*</span><span class="n">nfc_dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">struct</span> <span class="n">i2c_dev</span> <span class="o">*</span><span class="n">i2c_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nfc_dev</span><span class="o">-&gt;</span><span class="n">i2c_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_may_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_dev</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">pm_wakeup_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_dev</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">WAKEUP_SRC_TIMEOUT</span><span class="p">);</span>

	<span class="n">i2c_disable_irq</span><span class="p">(</span><span class="n">nfc_dev</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfc_dev</span><span class="o">-&gt;</span><span class="n">read_wq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>int i2c_read(struct nfc_dev *nfc_dev, char *buf, size_t count, int timeout)
{
	int ret;
	struct i2c_dev *i2c_dev = &amp;nfc_dev-&gt;i2c_dev;
	struct platform_gpio *nfc_gpio = &amp;nfc_dev-&gt;configs.gpio;

	pr_debug(&quot;%s: reading %zu bytes.\n&quot;, __func__, count);

	if (timeout &gt; NCI_CMD_RSP_TIMEOUT_MS)
		timeout = NCI_CMD_RSP_TIMEOUT_MS;

	if (count &gt; MAX_NCI_BUFFER_SIZE)
		count = MAX_NCI_BUFFER_SIZE;

	if (!gpio_get_value(nfc_gpio-&gt;irq)) {
		while (1) {
			ret = 0;
			if (!i2c_dev-&gt;irq_enabled) {
				i2c_dev-&gt;irq_enabled = true;
				enable_irq(i2c_dev-&gt;client-&gt;irq);
			}
			if (!gpio_get_value(nfc_gpio-&gt;irq)) {
				if (timeout) {
					ret = wait_event_interruptible_timeout(
						nfc_dev-&gt;read_wq,
						!i2c_dev-&gt;irq_enabled,
						msecs_to_jiffies(timeout));

					if (ret &lt;= 0) {
						pr_err(&quot;%s: timeout error\n&quot;,
						       __func__);
						goto err;
					}
				} else {
					ret = wait_event_interruptible(
						nfc_dev-&gt;read_wq,
						!i2c_dev-&gt;irq_enabled);
					if (ret) {
						pr_err(&quot;%s: err wakeup of wq\n&quot;,
						       __func__);
						goto err;
					}
				}
			}
			i2c_disable_irq(nfc_dev);

			if (gpio_get_value(nfc_gpio-&gt;irq))
				break;
			if (!gpio_get_value(nfc_gpio-&gt;ven)) {
				pr_info(&quot;%s: releasing read\n&quot;, __func__);
				ret = -EIO;
				goto err;
			}
			pr_warn(&quot;%s: spurious interrupt detected\n&quot;, __func__);
		}
	}

	memset(buf, 0x00, count);
	/* Read data */
	ret = i2c_master_recv(nfc_dev-&gt;i2c_dev.client, buf, count);
	if (ret &lt;= 0) {
		pr_err(&quot;%s: returned %d\n&quot;, __func__, ret);
		goto err;
	}
err:
	return ret;
}
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssize_t</span> <span class="n">nfc_i2c_dev_read</span><span class="p">(</span><span class="n">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">count</span><span class="p">,</span>
			 <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nb">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">struct</span> <span class="n">nfc_dev</span> <span class="o">*</span><span class="n">nfc_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span> <span class="n">nfc_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: f_flags has nonblock. try again</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfc_dev</span><span class="o">-&gt;</span><span class="n">read_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_read</span><span class="p">(</span><span class="n">nfc_dev</span><span class="p">,</span> <span class="n">nfc_dev</span><span class="o">-&gt;</span><span class="n">read_kbuf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_printf</span><span class="p">(</span><span class="n">nfc_dev</span><span class="o">-&gt;</span><span class="n">read_kbuf</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nfc_dev</span><span class="o">-&gt;</span><span class="n">read_kbuf</span><span class="p">,</span> <span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: failed to copy to user space</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nfc_dev</span><span class="o">-&gt;</span><span class="n">read_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>所以就把芯片回复的 CORE_SET_CONFIG_RSP 4002020000 回发给上层copy_to_user</p>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/tml/phTmlNfc.cc</p></li>
</ul>
<p>gpTransportObj-&gt;Read 完成,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">void</span><span class="o">*</span> <span class="n">phTmlNfc_TmlThread</span><span class="p">(</span><span class="n">void</span><span class="o">*</span> <span class="n">pParam</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">NFCSTATUS</span> <span class="n">wStatus</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>
  <span class="n">int32_t</span> <span class="n">dwNoBytesWrRd</span> <span class="o">=</span> <span class="n">PH_TMLNFC_RESET_VALUE</span><span class="p">;</span>
  <span class="n">uint8_t</span> <span class="n">temp</span><span class="p">[</span><span class="mi">260</span><span class="p">];</span>
  <span class="n">uint8_t</span> <span class="n">readRetryDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="o">/*</span> <span class="n">Transaction</span> <span class="n">info</span> <span class="n">buffer</span> <span class="n">to</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">to</span> <span class="n">Callback</span> <span class="n">Thread</span> <span class="o">*/</span>
  <span class="n">static</span> <span class="n">phTmlNfc_TransactInfo_t</span> <span class="n">tTransactionInfo</span><span class="p">;</span>
  <span class="o">/*</span> <span class="n">Structure</span> <span class="n">containing</span> <span class="n">Tml</span> <span class="n">callback</span> <span class="n">function</span> <span class="ow">and</span> <span class="n">parameters</span> <span class="n">to</span> <span class="n">be</span> <span class="n">invoked</span>
     <span class="n">by</span> <span class="n">the</span> <span class="n">callback</span> <span class="n">thread</span> <span class="o">*/</span>
  <span class="n">static</span> <span class="n">phLibNfc_DeferredCall_t</span> <span class="n">tDeferredInfo</span><span class="p">;</span>
  <span class="o">/*</span> <span class="n">Initialize</span> <span class="n">Message</span> <span class="n">structure</span> <span class="n">to</span> <span class="n">post</span> <span class="n">message</span> <span class="n">onto</span> <span class="n">Callback</span> <span class="n">Thread</span> <span class="o">*/</span>
  <span class="n">static</span> <span class="n">phLibNfc_Message_t</span> <span class="n">tMsg</span><span class="p">;</span>
  <span class="n">UNUSED</span><span class="p">(</span><span class="n">pParam</span><span class="p">);</span>
  <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Tml Reader Thread Started................</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>

  <span class="o">/*</span> <span class="n">Writer</span> <span class="n">thread</span> <span class="n">loop</span> <span class="n">shall</span> <span class="n">be</span> <span class="n">running</span> <span class="n">till</span> <span class="n">shutdown</span> <span class="ow">is</span> <span class="n">invoked</span> <span class="o">*/</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">bThreadDone</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">/*</span> <span class="n">If</span> <span class="n">Tml</span> <span class="n">write</span> <span class="ow">is</span> <span class="n">requested</span> <span class="o">*/</span>
    <span class="o">/*</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">to</span> <span class="n">success</span> <span class="n">initially</span> <span class="o">*/</span>
    <span class="n">wStatus</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>
    <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">rxSemaphore</span><span class="p">);</span>

    <span class="o">/*</span> <span class="n">If</span> <span class="n">Tml</span> <span class="n">read</span> <span class="ow">is</span> <span class="n">requested</span> <span class="o">*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tReadInfo</span><span class="o">.</span><span class="n">bEnable</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Read requested.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
      <span class="o">/*</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">to</span> <span class="n">success</span> <span class="n">initially</span> <span class="o">*/</span>
      <span class="n">wStatus</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>

      <span class="o">/*</span> <span class="n">Variable</span> <span class="n">to</span> <span class="n">fetch</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">read</span> <span class="o">*/</span>
      <span class="n">dwNoBytesWrRd</span> <span class="o">=</span> <span class="n">PH_TMLNFC_RESET_VALUE</span><span class="p">;</span>

      <span class="o">/*</span> <span class="n">Read</span> <span class="n">the</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">file</span> <span class="n">onto</span> <span class="n">the</span> <span class="n">buffer</span> <span class="o">*/</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">NULL</span> <span class="o">!=</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">pDevHandle</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Invoking I2C Read.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
        <span class="n">dwNoBytesWrRd</span> <span class="o">=</span>
            <span class="n">gpTransportObj</span><span class="o">-&gt;</span><span class="n">Read</span><span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">pDevHandle</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="mi">260</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">dwNoBytesWrRd</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">NXPLOG_TML_E</span><span class="p">(</span><span class="s2">&quot;PN54X - Error in I2C Read.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">readRetryDelay</span> <span class="o">&lt;</span> <span class="n">MAX_READ_RETRY_DELAY_IN_MILLISEC</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">/*</span><span class="n">sleep</span> <span class="k">for</span> <span class="mi">30</span><span class="o">/</span><span class="mi">60</span><span class="o">/</span><span class="mi">90</span><span class="o">/</span><span class="mi">120</span><span class="o">/</span><span class="mi">150</span> <span class="n">msec</span> <span class="n">between</span> <span class="n">each</span> <span class="n">read</span> <span class="n">trial</span> <span class="n">incase</span> <span class="n">of</span>
             <span class="o">*</span> <span class="n">read</span> <span class="n">error</span><span class="o">*/</span>
            <span class="n">readRetryDelay</span> <span class="o">+=</span> <span class="mi">30</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">usleep</span><span class="p">(</span><span class="n">readRetryDelay</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
          <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">rxSemaphore</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dwNoBytesWrRd</span> <span class="o">&gt;</span> <span class="mi">260</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">NXPLOG_TML_E</span><span class="p">(</span><span class="s2">&quot;Numer of bytes read exceeds the limit 260.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
          <span class="n">readRetryDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">rxSemaphore</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">readInfoUpdateMutex</span><span class="p">);</span>
          <span class="n">memcpy</span><span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tReadInfo</span><span class="o">.</span><span class="n">pBuffer</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">dwNoBytesWrRd</span><span class="p">);</span>
          <span class="n">readRetryDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

          <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - I2C Read successful.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
          <span class="o">/*</span> <span class="n">This</span> <span class="n">has</span> <span class="n">to</span> <span class="n">be</span> <span class="n">reset</span> <span class="n">only</span> <span class="n">after</span> <span class="n">a</span> <span class="n">successful</span> <span class="n">read</span> <span class="o">*/</span>
          <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tReadInfo</span><span class="o">.</span><span class="n">bEnable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">phTmlNfc_e_EnableRetrans</span> <span class="o">==</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">eConfig</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
              <span class="p">(</span><span class="mh">0x00</span> <span class="o">!=</span> <span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tReadInfo</span><span class="o">.</span><span class="n">pBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Retransmission timer stopped.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
            <span class="o">/*</span> <span class="n">Stop</span> <span class="n">Timer</span> <span class="n">to</span> <span class="n">prevent</span> <span class="n">Retransmission</span> <span class="o">*/</span>
            <span class="n">uint32_t</span> <span class="n">timerStatus</span> <span class="o">=</span>
                <span class="n">phOsalNfc_Timer_Stop</span><span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">dwTimerId</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">!=</span> <span class="n">timerStatus</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">NXPLOG_TML_E</span><span class="p">(</span><span class="s2">&quot;PN54X - timer stopped returned failure.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">bWriteCbInvoked</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tWriteInfo</span><span class="o">.</span><span class="n">bThreadBusy</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;Delay Read if write thread is busy&quot;</span><span class="p">);</span>
            <span class="n">usleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span> <span class="o">/*</span><span class="mi">2</span><span class="n">ms</span> <span class="n">delay</span> <span class="n">to</span> <span class="n">give</span> <span class="n">prio</span> <span class="n">to</span> <span class="n">write</span> <span class="n">complete</span> <span class="o">*/</span>
          <span class="p">}</span>
          <span class="o">/*</span> <span class="n">Update</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">read</span> <span class="n">including</span> <span class="n">header</span> <span class="o">*/</span>
          <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tReadInfo</span><span class="o">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint16_t</span><span class="p">)(</span><span class="n">dwNoBytesWrRd</span><span class="p">);</span>
          <span class="n">phNxpNciHal_print_packet</span><span class="p">(</span><span class="s2">&quot;RECV&quot;</span><span class="p">,</span>
                                   <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tReadInfo</span><span class="o">.</span><span class="n">pBuffer</span><span class="p">,</span>
                                   <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tReadInfo</span><span class="o">.</span><span class="n">wLength</span><span class="p">);</span>

          <span class="n">dwNoBytesWrRd</span> <span class="o">=</span> <span class="n">PH_TMLNFC_RESET_VALUE</span><span class="p">;</span>

          <span class="o">/*</span> <span class="n">Fill</span> <span class="n">the</span> <span class="n">Transaction</span> <span class="n">info</span> <span class="n">structure</span> <span class="n">to</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">to</span> <span class="n">Callback</span>
           <span class="o">*</span> <span class="n">Function</span> <span class="o">*/</span>
          <span class="n">tTransactionInfo</span><span class="o">.</span><span class="n">wStatus</span> <span class="o">=</span> <span class="n">wStatus</span><span class="p">;</span>
          <span class="n">tTransactionInfo</span><span class="o">.</span><span class="n">pBuff</span> <span class="o">=</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tReadInfo</span><span class="o">.</span><span class="n">pBuffer</span><span class="p">;</span>
          <span class="o">/*</span> <span class="n">Actual</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">read</span> <span class="ow">is</span> <span class="n">filled</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">structure</span> <span class="o">*/</span>
          <span class="n">tTransactionInfo</span><span class="o">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tReadInfo</span><span class="o">.</span><span class="n">wLength</span><span class="p">;</span>

          <span class="o">/*</span> <span class="n">Read</span> <span class="n">operation</span> <span class="n">completed</span> <span class="n">successfully</span><span class="o">.</span> <span class="n">Post</span> <span class="n">a</span> <span class="n">Message</span> <span class="n">onto</span> <span class="n">Callback</span>
           <span class="o">*</span> <span class="n">Thread</span><span class="o">*/</span>
          <span class="o">/*</span> <span class="n">Prepare</span> <span class="n">the</span> <span class="n">message</span> <span class="n">to</span> <span class="n">be</span> <span class="n">posted</span> <span class="n">on</span> <span class="n">User</span> <span class="n">thread</span> <span class="o">*/</span>
          <span class="n">tDeferredInfo</span><span class="o">.</span><span class="n">pCallback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phTmlNfc_ReadDeferredCb</span><span class="p">;</span>
          <span class="n">tDeferredInfo</span><span class="o">.</span><span class="n">pParameter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tTransactionInfo</span><span class="p">;</span>
          <span class="n">tMsg</span><span class="o">.</span><span class="n">eMsgType</span> <span class="o">=</span> <span class="n">PH_LIBNFC_DEFERREDCALL_MSG</span><span class="p">;</span>
          <span class="n">tMsg</span><span class="o">.</span><span class="n">pMsgData</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tDeferredInfo</span><span class="p">;</span>
          <span class="n">tMsg</span><span class="o">.</span><span class="n">Size</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">tDeferredInfo</span><span class="p">);</span>
          <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">readInfoUpdateMutex</span><span class="p">);</span>
          <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Posting read message.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
          <span class="n">phTmlNfc_DeferredCall</span><span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">dwCallbackThreadId</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tMsg</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X -gpphTmlNfc_Context-&gt;pDevHandle is NULL&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - read request NOT enabled&quot;</span><span class="p">);</span>
      <span class="n">usleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="o">/*</span> <span class="n">End</span> <span class="n">of</span> <span class="n">While</span> <span class="n">loop</span> <span class="o">*/</span>

  <span class="k">return</span> <span class="n">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>同发送原理一样,读取完成后,post一个message,PH_LIBNFC_DEFERREDCALL_MSG</p>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/hal/phNxpNciHal.cc</p></li>
</ul>
<p>message,都是调用callback</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">void</span><span class="o">*</span> <span class="n">phNxpNciHal_client_thread</span><span class="p">(</span><span class="n">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">phNxpNciHal_Control_t</span><span class="o">*</span> <span class="n">p_nxpncihal_ctrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">phNxpNciHal_Control_t</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
  <span class="n">phLibNfc_Message_t</span> <span class="n">msg</span><span class="p">;</span>

  <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;thread started&quot;</span><span class="p">);</span>

  <span class="n">p_nxpncihal_ctrl</span><span class="o">-&gt;</span><span class="n">thread_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">p_nxpncihal_ctrl</span><span class="o">-&gt;</span><span class="n">thread_running</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">/*</span> <span class="n">Fetch</span> <span class="nb">next</span> <span class="n">message</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">NFC</span> <span class="n">stack</span> <span class="n">message</span> <span class="n">queue</span> <span class="o">*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">phDal4Nfc_msgrcv</span><span class="p">(</span><span class="n">p_nxpncihal_ctrl</span><span class="o">-&gt;</span><span class="n">gDrvCfg</span><span class="o">.</span><span class="n">nClientId</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;NFC client received bad message&quot;</span><span class="p">);</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">p_nxpncihal_ctrl</span><span class="o">-&gt;</span><span class="n">thread_running</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">switch</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">eMsgType</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">PH_LIBNFC_DEFERREDCALL_MSG</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">phLibNfc_DeferredCall_t</span><span class="o">*</span> <span class="n">deferCall</span> <span class="o">=</span>
            <span class="p">(</span><span class="n">phLibNfc_DeferredCall_t</span><span class="o">*</span><span class="p">)(</span><span class="n">msg</span><span class="o">.</span><span class="n">pMsgData</span><span class="p">);</span>

        <span class="n">REENTRANCE_LOCK</span><span class="p">();</span>
        <span class="n">deferCall</span><span class="o">-&gt;</span><span class="n">pCallback</span><span class="p">(</span><span class="n">deferCall</span><span class="o">-&gt;</span><span class="n">pParameter</span><span class="p">);</span>
        <span class="n">REENTRANCE_UNLOCK</span><span class="p">();</span>

        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>回调自己,最开始是open的时候传入phNxpNciHal_MinOpen</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>static void phNxpNciHal_read_complete(void* pContext,
                                      phTmlNfc_TransactInfo_t* pInfo) {
  NFCSTATUS status = NFCSTATUS_FAILED;
  int sem_val;
  UNUSED(pContext);
  if (nxpncihal_ctrl.read_retry_cnt == 1) {
    nxpncihal_ctrl.read_retry_cnt = 0;
  }
  if (pInfo-&gt;wStatus == NFCSTATUS_SUCCESS) {
    NXPLOG_NCIHAL_D(&quot;read successful status = 0x%x&quot;, pInfo-&gt;wStatus);

    sem_getvalue(&amp;(nxpncihal_ctrl.syncSpiNfc), &amp;sem_val);
    if (((pInfo-&gt;pBuff[0] &amp; NCI_MT_MASK) == NCI_MT_RSP) &amp;&amp; sem_val == 0) {
      sem_post(&amp;(nxpncihal_ctrl.syncSpiNfc));
    }
    /*Check the Omapi command response and store in dedicated buffer to solve
     * sync issue*/
    if (pInfo-&gt;pBuff[0] == 0x4F &amp;&amp; pInfo-&gt;pBuff[1] == 0x01 &amp;&amp;
        pInfo-&gt;pBuff[2] == 0x01) {
      nxpncihal_ctrl.p_rx_ese_data = pInfo-&gt;pBuff;
      nxpncihal_ctrl.rx_ese_data_len = pInfo-&gt;wLength;
      SEM_POST(&amp;(nxpncihal_ctrl.ext_cb_data));
    } else {
      nxpncihal_ctrl.p_rx_data = pInfo-&gt;pBuff;
      nxpncihal_ctrl.rx_data_len = pInfo-&gt;wLength;
      status = phNxpNciHal_process_ext_rsp(nxpncihal_ctrl.p_rx_data,
                                           &amp;nxpncihal_ctrl.rx_data_len);
    }

    phNxpNciHal_print_res_status(pInfo-&gt;pBuff, &amp;pInfo-&gt;wLength);

    if ((nxpncihal_ctrl.p_rx_data[0x00] &amp; NCI_MT_MASK) == NCI_MT_NTF) {
      NfccPowerTracker::getInstance().ProcessNtf(nxpncihal_ctrl.p_rx_data,
                                                 nxpncihal_ctrl.rx_data_len);
    }
    /* Check if response should go to hal module only */
    if (nxpncihal_ctrl.hal_ext_enabled == TRUE &amp;&amp;
        (nxpncihal_ctrl.p_rx_data[0x00] &amp; NCI_MT_MASK) == NCI_MT_RSP) {
      if (status == NFCSTATUS_FAILED) {
        NXPLOG_NCIHAL_D(&quot;enter into NFCC init recovery&quot;);
        nxpncihal_ctrl.ext_cb_data.status = status;
      }
      /* Unlock semaphore only for responses*/
      if ((nxpncihal_ctrl.p_rx_data[0x00] &amp; NCI_MT_MASK) == NCI_MT_RSP ||
          ((icode_detected == true) &amp;&amp; (icode_send_eof == 3))) {
        /* Unlock semaphore */
        SEM_POST(&amp;(nxpncihal_ctrl.ext_cb_data));
      }
    }  // Notification Checking
    else if ((nxpncihal_ctrl.hal_ext_enabled == TRUE) &amp;&amp;
             ((nxpncihal_ctrl.p_rx_data[0x00] &amp; NCI_MT_MASK) == NCI_MT_NTF) &amp;&amp;
             (nxpncihal_ctrl.nci_info.wait_for_ntf == TRUE)) {
      /* Unlock semaphore waiting for only  ntf*/
      SEM_POST(&amp;(nxpncihal_ctrl.ext_cb_data));
      nxpncihal_ctrl.nci_info.wait_for_ntf = FALSE;
    } else if (bDisableLegacyMfcExtns &amp;&amp; !sendRspToUpperLayer &amp;&amp;
               (nxpncihal_ctrl.p_rx_data[0x00] == 0x00)) {
      sendRspToUpperLayer = true;
      NFCSTATUS mfcRspStatus = NxpMfcReaderInstance.CheckMfcResponse(
          nxpncihal_ctrl.p_rx_data, nxpncihal_ctrl.rx_data_len);
      NXPLOG_NCIHAL_D(&quot;Mfc Response Status = 0x%x&quot;, mfcRspStatus);
      SEM_POST(&amp;(nxpncihal_ctrl.ext_cb_data));
    }
    /* Read successful send the event to higher layer */
    else if ((nxpncihal_ctrl.p_nfc_stack_data_cback != NULL) &amp;&amp;
             (status == NFCSTATUS_SUCCESS)) {
      (*nxpncihal_ctrl.p_nfc_stack_data_cback)(nxpncihal_ctrl.rx_data_len,
                                               nxpncihal_ctrl.p_rx_data);
      // workaround for sync issue between SPI and NFC
      if ((nfcFL.chipType == pn557) &amp;&amp; nxpncihal_ctrl.p_rx_data[0] == 0x62 &amp;&amp;
          nxpncihal_ctrl.p_rx_data[1] == 0x00 &amp;&amp;
          nxpncihal_ctrl.p_rx_data[3] == 0xC0 &amp;&amp;
          nxpncihal_ctrl.p_rx_data[4] == 0x00) {
        uint8_t nfcee_notifiations[3][9] = {
            {0x61, 0x0A, 0x06, 0x01, 0x00, 0x03, 0xC0, 0x80, 0x04},
            {0x61, 0x0A, 0x06, 0x01, 0x00, 0x03, 0xC0, 0x81, 0x04},
            {0x61, 0x0A, 0x06, 0x01, 0x00, 0x03, 0xC0, 0x82, 0x03},
        };

        for (int i = 0; i &lt; 3; i++) {
          (*nxpncihal_ctrl.p_nfc_stack_data_cback)(
              sizeof(nfcee_notifiations[i]), nfcee_notifiations[i]);
        }
      }
    }
  } else {
    NXPLOG_NCIHAL_E(&quot;read error status = 0x%x&quot;, pInfo-&gt;wStatus);
  }

  if (nxpncihal_ctrl.halStatus == HAL_STATUS_CLOSE &amp;&amp;
      nxpncihal_ctrl.nci_info.wait_for_ntf == FALSE) {
    NXPLOG_NCIHAL_D(&quot;Ignoring read, HAL close triggered&quot;);
    return;
  }
  /* Read again because read must be pending always.*/
  status = phTmlNfc_Read(
      Rx_data, NCI_MAX_DATA_LEN,
      (pphTmlNfc_TransactCompletionCb_t)&amp;phNxpNciHal_read_complete, NULL);
  if (status != NFCSTATUS_PENDING) {
    NXPLOG_NCIHAL_E(&quot;read status error status = %x&quot;, status);
    /* TODO: Not sure how to handle this ? */
  }

  return;
}
</pre></div>
</div>
<p>#define CORE_RES_STATUS_BYTE 3</p>
<p>40 02 02 00 00 rsp对应解析如下, 所以返回 STATUS_OK</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">void</span> <span class="n">phNxpNciHal_print_res_status</span><span class="p">(</span><span class="n">uint8_t</span><span class="o">*</span> <span class="n">p_rx_data</span><span class="p">,</span> <span class="n">uint16_t</span><span class="o">*</span> <span class="n">p_len</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">static</span> <span class="n">uint8_t</span> <span class="n">response_buf</span><span class="p">[][</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;STATUS_OK&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;STATUS_REJECTED&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;STATUS_RF_FRAME_CORRUPTED&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;STATUS_FAILED&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;STATUS_NOT_INITIALIZED&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;STATUS_SYNTAX_ERROR&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;STATUS_SEMANTIC_ERROR&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;RFU&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;RFU&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;STATUS_INVALID_PARAM&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;STATUS_MESSAGE_SIZE_EXCEEDED&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;STATUS_UNDEFINED&quot;</span><span class="p">};</span>
  <span class="nb">int</span> <span class="n">status_byte</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p_rx_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p_rx_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x02</span> <span class="o">||</span> <span class="n">p_rx_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p_rx_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">p_rx_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">status_byte</span> <span class="o">=</span> <span class="n">p_rx_data</span><span class="p">[</span><span class="n">CORE_RES_STATUS_BYTE</span><span class="p">];</span>
      <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: response status =</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">,</span>
                      <span class="n">response_buf</span><span class="p">[</span><span class="n">status_byte</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: response status =</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">,</span> <span class="n">response_buf</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">phNxpNciClock</span><span class="o">.</span><span class="n">isClockSet</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">int</span> <span class="n">i</span><span class="p">,</span> <span class="nb">len</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">phNxpNciClock</span><span class="o">.</span><span class="n">p_rx_data</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p_len</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s2">&quot;169257710&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">len</span> <span class="o">=</span> <span class="o">*</span><span class="n">p_len</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">phNxpNciClock</span><span class="o">.</span><span class="n">p_rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phNxpNciRfSet</span><span class="o">.</span><span class="n">isGetRfSetting</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">int</span> <span class="n">i</span><span class="p">,</span> <span class="nb">len</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">phNxpNciRfSet</span><span class="o">.</span><span class="n">p_rx_data</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p_len</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s2">&quot;169258733&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">len</span> <span class="o">=</span> <span class="o">*</span><span class="n">p_len</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">phNxpNciRfSet</span><span class="o">.</span><span class="n">p_rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="o">//</span> <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: response status =0x</span><span class="si">%x</span><span class="s2">&quot;</span><span class="p">,</span><span class="vm">__func__</span><span class="p">,</span><span class="n">p_rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phNxpNciMwEepromArea</span><span class="o">.</span><span class="n">isGetEepromArea</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">int</span> <span class="n">i</span><span class="p">,</span> <span class="nb">len</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">phNxpNciMwEepromArea</span><span class="o">.</span><span class="n">p_rx_data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p_len</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s2">&quot;169258884&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">len</span> <span class="o">=</span> <span class="o">*</span><span class="n">p_len</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">phNxpNciMwEepromArea</span><span class="o">.</span><span class="n">p_rx_data</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">phNxpNciGpioInfo</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">GPIO_STORE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Storing GPIO Values...&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
      <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">phNxpNciGpioInfo</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_rx_data</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
      <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">phNxpNciGpioInfo</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_rx_data</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">phNxpNciGpioInfo</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">GPIO_RESTORE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Restoring GPIO Values...&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
      <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">phNxpNciGpioInfo</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_rx_data</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
      <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">phNxpNciGpioInfo</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_rx_data</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">p_rx_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">config_access</span> <span class="o">==</span> <span class="n">true</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p_rx_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_W</span><span class="p">(</span><span class="s2">&quot;Invalid Data from config file.&quot;</span><span class="p">);</span>
      <span class="n">config_success</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/tml/phTmlNfc.cc</p></li>
</ul>
<p>read进程,又进入read 等待, 驱动又会阻塞260ms</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">void</span><span class="o">*</span> <span class="n">phTmlNfc_TmlThread</span><span class="p">(</span><span class="n">void</span><span class="o">*</span> <span class="n">pParam</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">NFCSTATUS</span> <span class="n">wStatus</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>
  <span class="n">int32_t</span> <span class="n">dwNoBytesWrRd</span> <span class="o">=</span> <span class="n">PH_TMLNFC_RESET_VALUE</span><span class="p">;</span>
  <span class="n">uint8_t</span> <span class="n">temp</span><span class="p">[</span><span class="mi">260</span><span class="p">];</span>
  <span class="n">uint8_t</span> <span class="n">readRetryDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="o">/*</span> <span class="n">Transaction</span> <span class="n">info</span> <span class="n">buffer</span> <span class="n">to</span> <span class="n">be</span> <span class="n">passed</span> <span class="n">to</span> <span class="n">Callback</span> <span class="n">Thread</span> <span class="o">*/</span>
  <span class="n">static</span> <span class="n">phTmlNfc_TransactInfo_t</span> <span class="n">tTransactionInfo</span><span class="p">;</span>
  <span class="o">/*</span> <span class="n">Structure</span> <span class="n">containing</span> <span class="n">Tml</span> <span class="n">callback</span> <span class="n">function</span> <span class="ow">and</span> <span class="n">parameters</span> <span class="n">to</span> <span class="n">be</span> <span class="n">invoked</span>
     <span class="n">by</span> <span class="n">the</span> <span class="n">callback</span> <span class="n">thread</span> <span class="o">*/</span>
  <span class="n">static</span> <span class="n">phLibNfc_DeferredCall_t</span> <span class="n">tDeferredInfo</span><span class="p">;</span>
  <span class="o">/*</span> <span class="n">Initialize</span> <span class="n">Message</span> <span class="n">structure</span> <span class="n">to</span> <span class="n">post</span> <span class="n">message</span> <span class="n">onto</span> <span class="n">Callback</span> <span class="n">Thread</span> <span class="o">*/</span>
  <span class="n">static</span> <span class="n">phLibNfc_Message_t</span> <span class="n">tMsg</span><span class="p">;</span>
  <span class="n">UNUSED</span><span class="p">(</span><span class="n">pParam</span><span class="p">);</span>
  <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Tml Reader Thread Started................</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>

  <span class="o">/*</span> <span class="n">Writer</span> <span class="n">thread</span> <span class="n">loop</span> <span class="n">shall</span> <span class="n">be</span> <span class="n">running</span> <span class="n">till</span> <span class="n">shutdown</span> <span class="ow">is</span> <span class="n">invoked</span> <span class="o">*/</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">bThreadDone</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">/*</span> <span class="n">If</span> <span class="n">Tml</span> <span class="n">write</span> <span class="ow">is</span> <span class="n">requested</span> <span class="o">*/</span>
    <span class="o">/*</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">to</span> <span class="n">success</span> <span class="n">initially</span> <span class="o">*/</span>
    <span class="n">wStatus</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>
    <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">rxSemaphore</span><span class="p">);</span>

    <span class="o">/*</span> <span class="n">If</span> <span class="n">Tml</span> <span class="n">read</span> <span class="ow">is</span> <span class="n">requested</span> <span class="o">*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">tReadInfo</span><span class="o">.</span><span class="n">bEnable</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Read requested.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
      <span class="o">/*</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">to</span> <span class="n">success</span> <span class="n">initially</span> <span class="o">*/</span>
      <span class="n">wStatus</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>

      <span class="o">/*</span> <span class="n">Variable</span> <span class="n">to</span> <span class="n">fetch</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">read</span> <span class="o">*/</span>
      <span class="n">dwNoBytesWrRd</span> <span class="o">=</span> <span class="n">PH_TMLNFC_RESET_VALUE</span><span class="p">;</span>

      <span class="o">/*</span> <span class="n">Read</span> <span class="n">the</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">file</span> <span class="n">onto</span> <span class="n">the</span> <span class="n">buffer</span> <span class="o">*/</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">NULL</span> <span class="o">!=</span> <span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">pDevHandle</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NXPLOG_TML_D</span><span class="p">(</span><span class="s2">&quot;PN54X - Invoking I2C Read.....</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
        <span class="n">dwNoBytesWrRd</span> <span class="o">=</span>
            <span class="n">gpTransportObj</span><span class="o">-&gt;</span><span class="n">Read</span><span class="p">(</span><span class="n">gpphTmlNfc_Context</span><span class="o">-&gt;</span><span class="n">pDevHandle</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="mi">260</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>UM.9.15/hardware/nxp/nfc/pn8x/halimpl/hal/phNxpNciHal_ext.cc</p></li>
</ul>
<p>最终返回到,phNxpNciHal_process_ext_cmd_rsp 的 SEM_WAIT(nxpncihal_ctrl.ext_cb_data)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">NFCSTATUS</span> <span class="n">phNxpNciHal_process_ext_cmd_rsp</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">cmd_len</span><span class="p">,</span>
                                                 <span class="n">uint8_t</span><span class="o">*</span> <span class="n">p_cmd</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">NFCSTATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
  <span class="n">uint16_t</span> <span class="n">data_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="o">/*</span> <span class="n">Create</span> <span class="n">the</span> <span class="n">local</span> <span class="n">semaphore</span> <span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">phNxpNciHal_init_cb_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="p">,</span> <span class="n">NULL</span><span class="p">)</span> <span class="o">!=</span>
      <span class="n">NFCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Create ext_cb_data failed&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>

  <span class="o">/*</span> <span class="n">Send</span> <span class="n">ext</span> <span class="n">command</span> <span class="o">*/</span>
  <span class="n">data_written</span> <span class="o">=</span> <span class="n">phNxpNciHal_write_unlocked</span><span class="p">(</span><span class="n">cmd_len</span><span class="p">,</span> <span class="n">p_cmd</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">data_written</span> <span class="o">!=</span> <span class="n">cmd_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;phNxpNciHal_write failed for hal ext&quot;</span><span class="p">);</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">Start</span> <span class="n">timer</span> <span class="o">*/</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Start</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">,</span> <span class="n">HAL_EXTNS_WRITE_RSP_TIMEOUT</span><span class="p">,</span>
                                 <span class="o">&amp;</span><span class="n">hal_extns_write_rsp_timeout_cb</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Response timer started&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Response timer not started!!!&quot;</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">rsp</span> <span class="o">*/</span>
  <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Waiting after ext cmd sent&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SEM_WAIT</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;p_hal_ext-&gt;ext_cb_data.sem semaphore error&quot;</span><span class="p">);</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">Stop</span> <span class="n">Timer</span> <span class="o">*/</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Stop</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Response timer stopped&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Response timer stop ERROR!!!&quot;</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">android_errorWriteLog</span><span class="p">(</span><span class="mh">0x534e4554</span><span class="p">,</span> <span class="s2">&quot;153880630&quot;</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">/*</span> <span class="n">No</span> <span class="n">NTF</span> <span class="n">expected</span> <span class="k">for</span> <span class="n">OMAPI</span> <span class="n">command</span> <span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x2F</span> <span class="o">&amp;&amp;</span> <span class="n">p_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1</span> <span class="o">&amp;&amp;</span> <span class="n">p_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">nci_info</span><span class="o">.</span><span class="n">wait_for_ntf</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="o">/*</span> <span class="n">Start</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">NTF</span><span class="o">*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">nci_info</span><span class="o">.</span><span class="n">wait_for_ntf</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Start</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">,</span> <span class="n">HAL_EXTNS_WRITE_RSP_TIMEOUT</span><span class="p">,</span>
                                   <span class="o">&amp;</span><span class="n">hal_extns_write_rsp_timeout_cb</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Response timer started&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Response timer not started!!!&quot;</span><span class="p">);</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
      <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SEM_WAIT</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;p_hal_ext-&gt;ext_cb_data.sem semaphore error&quot;</span><span class="p">);</span>
      <span class="o">/*</span> <span class="n">Stop</span> <span class="n">Timer</span> <span class="o">*/</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Stop</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">);</span>
      <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">phOsalNfc_Timer_Stop</span><span class="p">(</span><span class="n">timeoutTimerId</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">NFCSTATUS_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Response timer stopped&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Response timer stop ERROR!!!&quot;</span><span class="p">);</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
      <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">NFCSTATUS_SUCCESS</span> <span class="o">&amp;&amp;</span>
      <span class="n">p_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x2F</span> <span class="o">&amp;&amp;</span> <span class="n">p_cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x1</span> <span class="o">&amp;&amp;</span> <span class="n">p_cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span>
        <span class="s2">&quot;Callback Status is failed!! Timer Expired!! Couldn&#39;t read it! 0x</span><span class="si">%x</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="o">.</span><span class="n">status</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
    <span class="n">goto</span> <span class="n">clean_and_return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">NXPLOG_NCIHAL_D</span><span class="p">(</span><span class="s2">&quot;Checking response&quot;</span><span class="p">);</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">;</span>

<span class="n">clean_and_return</span><span class="p">:</span>
  <span class="n">phNxpNciHal_cleanup_cb_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">ext_cb_data</span><span class="p">);</span>
  <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">nci_info</span><span class="o">.</span><span class="n">wait_for_ntf</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>返回 phNxpNciHal_send_ext_cmd 函数</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NFCSTATUS</span> <span class="n">phNxpNciHal_send_ext_cmd</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">uint8_t</span><span class="o">*</span> <span class="n">p_cmd</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">NFCSTATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="n">NFCSTATUS_FAILED</span><span class="p">;</span>
  <span class="n">HAL_ENABLE_EXT</span><span class="p">();</span>
  <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span> <span class="o">=</span> <span class="n">cmd_len</span><span class="p">;</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_cmd_data</span><span class="p">,</span> <span class="n">p_cmd</span><span class="p">,</span> <span class="n">cmd_len</span><span class="p">);</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">phNxpNciHal_process_ext_cmd_rsp</span><span class="p">(</span><span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">cmd_len</span><span class="p">,</span>
                                           <span class="n">nxpncihal_ctrl</span><span class="o">.</span><span class="n">p_cmd_data</span><span class="p">);</span>
  <span class="n">HAL_DISABLE_EXT</span><span class="p">();</span>

  <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>最后返回调用写入配置文件的函数</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>08-29 03:02:34.771   903   903 E NxpHal  : PAX Antenna write NFC parameter  ro.fac.cfg.NFC_PARA_1 success!
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">phNxpNciHal_core_initialized</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">core_init_rsp_params_len</span><span class="p">,</span>
                                 <span class="n">uint8_t</span><span class="o">*</span> <span class="n">p_core_init_rsp_params</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">numOfRfAntenna</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">retlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;Performing PAX Antenna Setting BLK </span><span class="si">%u</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">antenna_string_buffer</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">antenna_string_buffer</span><span class="p">));</span>
    <span class="n">retlen</span> <span class="o">=</span> <span class="n">property_get</span><span class="p">(</span><span class="n">RF_ANTENNA_PARAMETER_LIST</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">antenna_string_buffer</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">CStringToHexArray</span><span class="p">(</span><span class="n">antenna_string_buffer</span><span class="p">,</span> <span class="n">antenna_hex_buffer</span><span class="p">);</span>
      <span class="n">retlen</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="o">//</span><span class="n">兼容之前用2002开头的配置文件</span>
      <span class="k">if</span><span class="p">((</span><span class="n">antenna_hex_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">antenna_hex_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
                  <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;PAX config file error!&quot;</span><span class="p">);</span>
                  <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">phNxpNciHal_send_ext_cmd</span><span class="p">(</span><span class="n">retlen</span><span class="p">,</span> <span class="n">antenna_hex_buffer</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">nfcFL</span><span class="o">.</span><span class="n">chipType</span> <span class="o">!=</span> <span class="n">pn547C2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">))</span> <span class="p">{</span>
              <span class="n">status</span> <span class="o">=</span> <span class="n">phNxpNciHal_CheckRFCmdRespStatus</span><span class="p">();</span>
              <span class="o">/*</span><span class="n">STATUS</span> <span class="n">INVALID</span> <span class="n">PARAM</span> <span class="mh">0x09</span><span class="o">*/</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0x09</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">phNxpNciHalRFConfigCmdRecSequence</span><span class="p">();</span>
                  <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;PAX Antenna write NFC parameter  </span><span class="si">%s</span><span class="s2"> success!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">RF_ANTENNA_PARAMETER_LIST</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">NFCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">NXPLOG_NCIHAL_E</span><span class="p">(</span><span class="s2">&quot;PAX Antenna Setting BLK </span><span class="si">%u</span><span class="s2"> failed&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id6">
<h1>Log<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>08-29 03:02:34.766   903   903 E NxpHal  : Performing PAX Antenna Setting BLK 1
08-29 03:02:34.766   903   903 D NfccPowerTracker: NfccPowerTracker::ProcessCmd: Enter, Received len :44
08-29 03:02:34.766   903  5027 D NxpTml  : PN54X - Write requested.....
08-29 03:02:34.766   903  5027 D NxpTml  : PN54X - Invoking I2C Write.....
08-29 03:02:34.760     0     0 E nfc nRead: CORE_SET_CONFIG_RSP                4002020000
08-29 03:02:34.763     0     0 E nfc write: CORE_GET_CONFIG_CMD                20030703A002A003A004
08-29 03:02:34.765     0     0 E nfc nRead: CORE_GET_CONFIG_RSP                40030E0003A0020101A0030108A0040101
08-29 03:02:34.766     0     0 E nfc write: CORE_SET_CONFIG_CMD                20022905A00D047242F840A00D06724A0007001BA00D03721601A00D063C44660A0000A00D063C2DDC400400
08-29 03:02:34.768   903  5027 D NxpNciX : len =  44 &gt; 20022905A00D047242F840A00D06724A0007001BA00D03721601A00D063C44660A0000A00D063C2DDC400400
08-29 03:02:34.768   903  5027 D NxpTml  : PN54X - I2C Write successful.....
08-29 03:02:34.768   903  5027 D NxpTml  : PN54X - Posting Fresh Write message.....
08-29 03:02:34.768   903  5027 D NxpTml  : PN54X - Tml Writer Thread Running................
08-29 03:02:34.768   903  5029 D NxpHal  : write successful status = 0x0
08-29 03:02:34.768   903   903 D NxpHal  : Response timer started
08-29 03:02:34.768   903   903 D NxpHal  : Waiting after ext cmd sent
08-29 03:02:34.771   903  5026 D NxpTml  : PN54X - I2C Read successful.....
08-29 03:02:34.771   903  5026 D NxpNciR : len =   5 &gt; 4002020000
08-29 03:02:34.771   903  5026 D NxpTml  : PN54X - Posting read message.....
08-29 03:02:34.771   903  5029 D NxpHal  : read successful status = 0x0
08-29 03:02:34.771   903  5029 D NxpHal  : phNxpNciHal_print_res_status: response status =STATUS_OK
08-29 03:02:34.771   903  5026 D NxpTml  : PN54X - Read requested.....
08-29 03:02:34.771   903  5026 D NxpTml  : PN54X - Invoking I2C Read.....
08-29 03:02:34.771   903   903 D NxpHal  : Response timer stopped
08-29 03:02:34.771   903   903 D NxpHal  : Checking response
08-29 03:02:34.771   903   903 E NxpHal  : PAX Antenna write NFC parameter  ro.fac.cfg.NFC_PARA_1 success!
</pre></div>
</div>
</section>
<section id="id7">
<h1>总结<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h1>
<p>虽然流程比较多,但是整体逻辑不是太复杂</p>
<p>分为读进程,写进程</p>
<p>其他的都是nci指令</p>
<p>写入参数后,读取nfc卡片,明显快多了.</p>
</section>
<section id="id8">
<h1>配置文件 指令解析<a class="headerlink" href="#id8" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>NFC_PARA_1=”20022905A00D047242F840A00D06724A0007001BA00D03721601A00D063C44660A0000A00D063C2DDC400400”</p></li>
</ul>
<p>配置参数命令,CORE_SET_CONFIG_CMD</p>
<ul class="simple">
<li><p>NFC_PARA_2=”20022905A00D048242A840A00D06824A11070007A00D03821600A00D064C4465090000A00D064C2D05351E01”</p></li>
</ul>
<p>配置参数命令,CORE_SET_CONFIG_CMD</p>
<ul class="simple">
<li><p>NFC_PARA_3=”20022905A00D049442A840A00D06944A11070007A00D03941600A00D065E4455080000A00D065E2D0D480C01”</p></li>
</ul>
<p>配置参数命令,CORE_SET_CONFIG_CMD</p>
<ul class="simple">
<li><p>NFC_PARA_4=”20022905A00D0496428040A00D06964A11070107A00D03961600A00D06604455080000A00D06602D0D5A0C01”</p></li>
</ul>
<p>配置参数命令,CORE_SET_CONFIG_CMD</p>
<ul class="simple">
<li><p>NFC_PARA_5=”20020A01A00D062044660A0000”</p></li>
</ul>
<p>配置参数命令,CORE_SET_CONFIG_CMD</p>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, victor。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
  

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id: "JoV5csIHTGhHiGQ4",ck: "JoV5csIHTGhHiGQ4"})</script>

<br/>
<script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JoV5csIHTGhHiGQ4/quote.js?theme=#4C8AC2,#BB2626,#040000,#333333,#AE3535,#1690FF,14&f=14"></script>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>